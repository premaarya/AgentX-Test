# Multi-Agent Orchestration Configuration
# Defines routing rules and workflow definitions for automatic agent orchestration
# Part of AgentX Phase 1 MVP

version: "1.0"

# =============================================================================
# ROUTING RULES
# Maps issue labels to workflows
# Note: Rules are evaluated in order. Epic and needs:ux modifier rules come first.
# =============================================================================
routing:
  # Epic: Product Manager creates PRD and backlog
  - trigger:
      labels: ["type:epic"]
      event: "opened"
    workflow: "epic-workflow"
    priority: 0

  # Feature with UX requirement: UX Designer first (triggered by needs:ux label)
  - trigger:
      labels: ["type:feature", "needs:ux"]
      event: "opened"
    workflow: "feature-ux-workflow"
    priority: 1

  # Story with UX requirement
  - trigger:
      labels: ["type:story", "needs:ux"]
      event: "opened"
    workflow: "feature-ux-workflow"
    priority: 1

  # Feature development: Full workflow
  - trigger:
      labels: ["type:feature"]
      event: "opened"
    workflow: "feature-workflow"
    priority: 2

  # User stories: Full workflow
  - trigger:
      labels: ["type:story"]
      event: "opened"
    workflow: "feature-workflow"
    priority: 2

  # Bug fixes: Skip architect
  - trigger:
      labels: ["type:bug"]
      event: "opened"
    workflow: "bug-workflow"
    priority: 3

  # Spikes/Research: Architect only
  - trigger:
      labels: ["type:spike"]
      event: "opened"
    workflow: "spike-workflow"
    priority: 4

  # UX work: UX Designer first
  - trigger:
      labels: ["type:ux"]
      event: "opened"
    workflow: "ux-workflow"
    priority: 3

  # Documentation: Engineer only
  - trigger:
      labels: ["type:docs"]
      event: "opened"
    workflow: "docs-workflow"
    priority: 5

  # Refactoring: Full workflow
  - trigger:
      labels: ["type:refactor"]
      event: "opened"
    workflow: "feature-workflow"
    priority: 3

  # Security issues: Reviewer first
  - trigger:
      labels: ["type:security"]
      event: "opened"
    workflow: "security-workflow"
    priority: 2

# =============================================================================
# WORKFLOW DEFINITIONS
# Defines the sequence of agents for each workflow type
# =============================================================================
workflows:
  epic-workflow:
    name: "Epic Planning"
    description: "Product Manager creates PRD and breaks down into backlog"
    stages:
      - agent: "product-manager"
        name: "PRD & Backlog"
        gate:
          required_outputs: ["prd", "epic_issue", "feature_issues", "story_issues"]
          validation: "issues_created"

  feature-workflow:
    name: "Feature Development"
    description: "Full workflow for new features: design â†’ implement â†’ review"
    stages:
      - agent: "architect"
        name: "Design"
        gate:
          required_outputs: ["adr", "spec"]
          validation: "files_exist"
      - agent: "engineer"
        name: "Implement"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Review"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

  feature-ux-workflow:
    name: "Feature with UX Design"
    description: "UX-first feature workflow: UX design â†’ architecture â†’ implement â†’ review"
    trigger_labels: ["type:feature", "needs:ux"]
    stages:
      - agent: "ux-designer"
        name: "UX Design"
        gate:
          required_outputs: ["wireframes", "flows", "ux_spec"]
          validation: "files_exist"
      - agent: "architect"
        name: "Technical Design"
        gate:
          required_outputs: ["adr", "spec"]
          validation: "files_exist"
      - agent: "engineer"
        name: "Implement"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Review"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

  bug-workflow:
    name: "Bug Fix"
    description: "Quick fix workflow: implement â†’ review"
    stages:
      - agent: "engineer"
        name: "Fix"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Review"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

  spike-workflow:
    name: "Research Spike"
    description: "Research and design only"
    stages:
      - agent: "architect"
        name: "Research"
        gate:
          required_outputs: ["findings"]
          validation: "document_exists"

  ux-workflow:
    name: "UX Design"
    description: "UX-first workflow: design â†’ architect â†’ implement"
    stages:
      - agent: "ux-designer"
        name: "UX Design"
        gate:
          required_outputs: ["wireframes", "flows"]
          validation: "files_exist"
      - agent: "architect"
        name: "Technical Design"
        gate:
          required_outputs: ["spec"]
          validation: "files_exist"
      - agent: "engineer"
        name: "Implement"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"

  docs-workflow:
    name: "Documentation"
    description: "Documentation only"
    stages:
      - agent: "engineer"
        name: "Write Docs"
        gate:
          required_outputs: ["docs"]
          validation: "files_exist"

  security-workflow:
    name: "Security Issue"
    description: "Security-first: audit â†’ fix â†’ re-audit"
    stages:
      - agent: "reviewer"
        name: "Security Audit"
        gate:
          required_outputs: ["audit_report"]
          validation: "document_exists"
      - agent: "engineer"
        name: "Fix"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Re-audit"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

# =============================================================================
# AGENT CONFIGURATION
# Defines capabilities and constraints for each agent
# =============================================================================
agents:
  architect:
    name: "Solution Architect"
    description: "Designs systems, creates ADRs, defines APIs"
    agent_file: ".github/agents/architect.agent.md"
    allowed_tools:
      - read_file
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - create_file
      - run_in_terminal
    output_types:
      - adr
      - spec
      - diagram
      - api_design
    max_iterations: 10
    token_budget: 50000

  engineer:
    name: "Software Engineer"
    description: "Implements features, writes code and tests"
    agent_file: ".github/agents/engineer.agent.md"
    allowed_tools:
      - read_file
      - create_file
      - replace_string_in_file
      - run_in_terminal
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - get_errors
    output_types:
      - code
      - tests
      - docs
    max_iterations: 15
    token_budget: 100000

  reviewer:
    name: "Code Reviewer"
    description: "Reviews code, performs security audits"
    agent_file: ".github/agents/reviewer.agent.md"
    allowed_tools:
      - read_file
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - get_errors
    output_types:
      - review
      - approval
      - audit_report
    max_iterations: 8
    token_budget: 30000

  ux-designer:
    name: "UX Designer"
    description: "Creates user flows, wireframes, UX research"
    agent_file: ".github/agents/ux-designer.agent.md"
    allowed_tools:
      - read_file
      - create_file
      - semantic_search
      - list_dir
      - run_in_terminal
      - get_changed_files
    output_types:
      - wireframes
      - flows
      - research
    max_iterations: 8
    token_budget: 30000

  product-manager:
    name: "Product Manager"
    description: "Creates PRD, breaks down epics into features and stories"
    agent_file: ".github/agents/product-manager.agent.md"
    allowed_tools:
      - read_file
      - create_file
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - run_in_terminal
      - get_changed_files
    output_types:
      - prd
      - epic_issue
      - feature_issues
      - story_issues
    max_iterations: 10
    token_budget: 50000

# =============================================================================
# STATE TRACKING
# Status is tracked via GitHub Projects V2 Status field, NOT labels
# =============================================================================
status_tracking:
  # Primary: GitHub Projects V2 Status field
  # Backlog â†’ In Progress â†’ In Review â†’ Ready â†’ Done
  
  # Status transitions by workflow phase:
  # PM completes PRD â†’ Status = Ready
  # UX completes designs â†’ Status = Ready
  # Architect completes spec â†’ Status = Ready
  # Engineer starts work â†’ Status = In Progress
  # Engineer completes code â†’ Status = In Review
  # Reviewer approves â†’ Status = Done + Close

  # Labels are for type classification only:
  type_labels:
    - "type:epic"
    - "type:feature"
    - "type:story"
    - "type:bug"
    - "type:spike"
    - "type:docs"
  
  # Workflow labels (NOT for status)
  workflow_labels:
    - "needs:ux"
    - "needs:help"
    - "needs:changes"

# =============================================================================
# COMMANDS
# Slash commands for manual control
# =============================================================================
commands:
  - command: "/orchestrate"
    description: "Start orchestration for this issue"
    action: "start_workflow"
  
  - command: "/pause"
    description: "Pause the current workflow"
    action: "pause_workflow"
  
  - command: "/resume"
    description: "Resume a paused workflow"
    action: "resume_workflow"
  
  - command: "/skip"
    description: "Skip current stage (e.g., /skip architect)"
    action: "skip_stage"
  
  - command: "/retry"
    description: "Retry current stage"
    action: "retry_stage"
  
  - command: "/route"
    description: "Manually route to agent (e.g., /route engineer)"
    action: "manual_route"

# =============================================================================
# SETTINGS
# Global orchestration settings
# =============================================================================
settings:
  # Auto-start orchestration when issue is labeled
  auto_start: true
  
  # Create handoff comments between stages
  create_handoff_comments: true
  
  # Require human approval between stages (global default)
  require_human_approval: false
  
  # Maximum time per stage (minutes)
  stage_timeout: 60
  
  # Allowed branches for orchestration
  allowed_branches:
    - main
    - master
    - develop

# =============================================================================
# APPROVAL GATES (IDEO-style Human-in-Loop)
# Optional human approval checkpoints between workflow stages
# =============================================================================
approval_gates:
  # Epic workflow: Review after PM creates backlog
  - workflow: "epic-workflow"
    stage: "product-manager"
    stage_after: "PRD & Backlog"
    require_approval: false  # Set to true to require human review
    approval_label: "needs:approval"
    reason: "Review Epic scope and resource allocation before design phase"
    approvers:
      - "stakeholders"
      - "tech-leads"
  
  # Feature workflow: Review after design phase
  - workflow: "feature-workflow"
    stage: "architect"
    stage_after: "Technical Design"
    require_approval: false
    approval_label: "needs:approval"
    reason: "Architectural decisions need stakeholder review"
    approvers:
      - "architects"
      - "security-team"
  
  # UX workflow: Review designs before implementation
  - workflow: "feature-ux-workflow"
    stage: "ux-designer"
    stage_after: "UX Design"
    require_approval: false
    approval_label: "needs:approval"
    reason: "Design review with product/stakeholders"
    approvers:
      - "design-leads"
      - "product-managers"

  # High-priority features: Require approval before implementation
  - workflow: "feature-workflow"
    stage: "engineer"
    stage_after: "Implement"
    require_approval: false
    priority_override: "priority:p0"  # Only for P0 issues
    approval_label: "needs:approval"
    reason: "Critical feature - verify scope before engineering effort"
    approvers:
      - "engineering-leads"

  # Security workflow: Require security team approval
  - workflow: "security-workflow"
    stage: "reviewer"
    stage_after: "Security Audit"
    require_approval: true  # Always require for security issues
    approval_label: "needs:security-approval"
    reason: "Security changes must be reviewed by security team"
    approvers:
      - "security-team"
      - "compliance-team"

# Approval gate behavior:
# - When require_approval: true, Orchestrator pauses workflow
# - Adds approval_label to issue
# - Posts comment tagging approvers
# - Waits for manual "/approve" command or label removal
# - Then continues to next stage
#
# Example approval comment:
# ðŸ›‘ **Approval Required**
# 
# This workflow requires approval before proceeding.
# 
# **Stage**: Technical Design â†’ Implementation
# **Reason**: Architectural decisions need stakeholder review
# **Approvers**: @architects @security-team
# 
# To approve: Comment `/approve` or remove `needs:approval` label
# To reject: Comment `/reject [reason]` and update design
