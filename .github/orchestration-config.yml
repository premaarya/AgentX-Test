# Multi-Agent Orchestration Configuration
# Defines routing rules and workflow definitions for automatic agent orchestration
# Part of AgentX Phase 1 MVP

version: "1.0"

# =============================================================================
# ROUTING RULES
# Maps issue labels to workflows
# Note: Rules are evaluated in order. Epic and needs:ux modifier rules come first.
# =============================================================================
routing:
  # Epic: Product Manager creates PRD and backlog
  - trigger:
      labels: ["type:epic"]
      event: "opened"
    workflow: "epic-workflow"
    priority: 0

  # Feature with UX requirement: UX Designer first (triggered by needs:ux label)
  - trigger:
      labels: ["type:feature", "needs:ux"]
      event: "opened"
    workflow: "feature-ux-workflow"
    priority: 1

  # Story with UX requirement
  - trigger:
      labels: ["type:story", "needs:ux"]
      event: "opened"
    workflow: "feature-ux-workflow"
    priority: 1

  # Feature development: Full workflow
  - trigger:
      labels: ["type:feature"]
      event: "opened"
    workflow: "feature-workflow"
    priority: 2

  # User stories: Full workflow
  - trigger:
      labels: ["type:story"]
      event: "opened"
    workflow: "feature-workflow"
    priority: 2

  # Bug fixes: Skip architect
  - trigger:
      labels: ["type:bug"]
      event: "opened"
    workflow: "bug-workflow"
    priority: 3

  # Spikes/Research: Architect only
  - trigger:
      labels: ["type:spike"]
      event: "opened"
    workflow: "spike-workflow"
    priority: 4

  # UX work: UX Designer first
  - trigger:
      labels: ["type:ux"]
      event: "opened"
    workflow: "ux-workflow"
    priority: 3

  # Documentation: Engineer only
  - trigger:
      labels: ["type:docs"]
      event: "opened"
    workflow: "docs-workflow"
    priority: 5

  # Refactoring: Full workflow
  - trigger:
      labels: ["type:refactor"]
      event: "opened"
    workflow: "feature-workflow"
    priority: 3

  # Security issues: Reviewer first
  - trigger:
      labels: ["type:security"]
      event: "opened"
    workflow: "security-workflow"
    priority: 2

# =============================================================================
# WORKFLOW DEFINITIONS
# Defines the sequence of agents for each workflow type
# =============================================================================
workflows:
  epic-workflow:
    name: "Epic Planning"
    description: "Product Manager creates PRD and breaks down into backlog"
    stages:
      - agent: "product-manager"
        name: "PRD & Backlog"
        gate:
          required_outputs: ["prd", "epic_issue", "feature_issues", "story_issues"]
          validation: "issues_created"

  feature-workflow:
    name: "Feature Development"
    description: "Full workflow for new features: design → implement → review"
    stages:
      - agent: "architect"
        name: "Design"
        gate:
          required_outputs: ["adr", "spec"]
          validation: "files_exist"
      - agent: "engineer"
        name: "Implement"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Review"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

  feature-ux-workflow:
    name: "Feature with UX Design"
    description: "UX-first feature workflow: UX design → architecture → implement → review"
    trigger_labels: ["type:feature", "needs:ux"]
    stages:
      - agent: "ux-designer"
        name: "UX Design"
        gate:
          required_outputs: ["wireframes", "flows", "ux_spec"]
          validation: "files_exist"
      - agent: "architect"
        name: "Technical Design"
        gate:
          required_outputs: ["adr", "spec"]
          validation: "files_exist"
      - agent: "engineer"
        name: "Implement"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Review"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

  bug-workflow:
    name: "Bug Fix"
    description: "Quick fix workflow: implement → review"
    stages:
      - agent: "engineer"
        name: "Fix"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Review"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

  spike-workflow:
    name: "Research Spike"
    description: "Research and design only"
    stages:
      - agent: "architect"
        name: "Research"
        gate:
          required_outputs: ["findings"]
          validation: "document_exists"

  ux-workflow:
    name: "UX Design"
    description: "UX-first workflow: design → architect → implement"
    stages:
      - agent: "ux-designer"
        name: "UX Design"
        gate:
          required_outputs: ["wireframes", "flows"]
          validation: "files_exist"
      - agent: "architect"
        name: "Technical Design"
        gate:
          required_outputs: ["spec"]
          validation: "files_exist"
      - agent: "engineer"
        name: "Implement"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"

  docs-workflow:
    name: "Documentation"
    description: "Documentation only"
    stages:
      - agent: "engineer"
        name: "Write Docs"
        gate:
          required_outputs: ["docs"]
          validation: "files_exist"

  security-workflow:
    name: "Security Issue"
    description: "Security-first: audit → fix → re-audit"
    stages:
      - agent: "reviewer"
        name: "Security Audit"
        gate:
          required_outputs: ["audit_report"]
          validation: "document_exists"
      - agent: "engineer"
        name: "Fix"
        gate:
          required_outputs: ["code", "tests"]
          validation: "tests_pass"
      - agent: "reviewer"
        name: "Re-audit"
        gate:
          required_outputs: ["approval"]
          validation: "pr_approved"

# =============================================================================
# AGENT CONFIGURATION
# Defines capabilities and constraints for each agent
# =============================================================================
agents:
  architect:
    name: "Solution Architect"
    description: "Designs systems, creates ADRs, defines APIs"
    agent_file: ".github/agents/architect.agent.md"
    allowed_tools:
      - read_file
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - create_file
      - run_in_terminal
    output_types:
      - adr
      - spec
      - diagram
      - api_design
    max_iterations: 10
    token_budget: 50000

  engineer:
    name: "Software Engineer"
    description: "Implements features, writes code and tests"
    agent_file: ".github/agents/engineer.agent.md"
    allowed_tools:
      - read_file
      - create_file
      - replace_string_in_file
      - run_in_terminal
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - get_errors
    output_types:
      - code
      - tests
      - docs
    max_iterations: 15
    token_budget: 100000

  reviewer:
    name: "Code Reviewer"
    description: "Reviews code, performs security audits"
    agent_file: ".github/agents/reviewer.agent.md"
    allowed_tools:
      - read_file
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - get_errors
    output_types:
      - review
      - approval
      - audit_report
    max_iterations: 8
    token_budget: 30000

  ux-designer:
    name: "UX Designer"
    description: "Creates user flows, wireframes, UX research"
    agent_file: ".github/agents/ux-designer.agent.md"
    allowed_tools:
      - read_file
      - create_file
      - semantic_search
      - list_dir
      - run_in_terminal
      - get_changed_files
    output_types:
      - wireframes
      - flows
      - research
    max_iterations: 8
    token_budget: 30000

  product-manager:
    name: "Product Manager"
    description: "Creates PRD, breaks down epics into features and stories"
    agent_file: ".github/agents/product-manager.agent.md"
    allowed_tools:
      - read_file
      - create_file
      - semantic_search
      - grep_search
      - file_search
      - list_dir
      - run_in_terminal
      - get_changed_files
    output_types:
      - prd
      - epic_issue
      - feature_issues
      - story_issues
    max_iterations: 10
    token_budget: 50000

# =============================================================================
# STATE LABELS
# Labels used to track workflow state
# =============================================================================
state_labels:
  # Workflow stages
  stage_prefix: "stage:"
  stages:
    - "stage:product-manager"
    - "stage:architect"
    - "stage:engineer"
    - "stage:reviewer"
    - "stage:ux-designer"
    - "stage:complete"
  
  # Workflow status
  status_prefix: "orchestration:"
  statuses:
    - "orchestration:active"
    - "orchestration:paused"
    - "orchestration:blocked"
    - "orchestration:complete"
    - "orchestration:failed"

# =============================================================================
# COMMANDS
# Slash commands for manual control
# =============================================================================
commands:
  - command: "/orchestrate"
    description: "Start orchestration for this issue"
    action: "start_workflow"
  
  - command: "/pause"
    description: "Pause the current workflow"
    action: "pause_workflow"
  
  - command: "/resume"
    description: "Resume a paused workflow"
    action: "resume_workflow"
  
  - command: "/skip"
    description: "Skip current stage (e.g., /skip architect)"
    action: "skip_stage"
  
  - command: "/retry"
    description: "Retry current stage"
    action: "retry_stage"
  
  - command: "/route"
    description: "Manually route to agent (e.g., /route engineer)"
    action: "manual_route"

# =============================================================================
# SETTINGS
# Global orchestration settings
# =============================================================================
settings:
  # Auto-start orchestration when issue is labeled
  auto_start: true
  
  # Create handoff comments between stages
  create_handoff_comments: true
  
  # Require human approval between stages
  require_human_approval: false
  
  # Maximum time per stage (minutes)
  stage_timeout: 60
  
  # Allowed branches for orchestration
  allowed_branches:
    - main
    - master
    - develop
