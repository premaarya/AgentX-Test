# Run Architect Agent (Solution Architect)
# Triggered by orchestrator to perform requirements analysis and design tasks
# Produces ADR (Architecture Decision) and Tech Spec (Technical Specification)
# Part of AgentX Phase 1 MVP
# Note: Workflow runs only via workflow_dispatch. GitHub may show phantom 'failure' on push - ignore these.

name: Run Architect Agent

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string
      workflow_type:
        description: 'Type of workflow (feature, spike, etc.)'
        required: true
        type: string
      stage:
        description: 'Current stage number'
        required: true
        type: string

jobs:
  architect:
    name: ğŸ—ï¸ Solution Architect Agent
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue context
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}')
            });
            
            // Get comments for additional context
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}')
            });
            
            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body || '');
            core.setOutput('labels', issue.data.labels.map(l => l.name).join(','));
            
            // Extract any previous agent outputs from comments
            const agentComments = comments.data.filter(c => 
              c.body.includes('## ğŸ—ï¸ Architect') || 
              c.body.includes('## ğŸ’» Engineer') ||
              c.body.includes('## ğŸ” Reviewer')
            );
            
            if (agentComments.length > 0) {
              core.setOutput('previous_context', agentComments.map(c => c.body).join('\n---\n'));
            } else {
              core.setOutput('previous_context', 'No previous agent context');
            }

      - name: Post start comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body: `## ğŸ—ï¸ Solution Architect Agent - Working...

**Task**: Analyzing requirements and creating PRD + ADR + Tech Spec

**Phase 1 - Product Requirements (PRD)**:
- [ ] Analyzing user input and problem statement
- [ ] Defining user stories with acceptance criteria
- [ ] Establishing scope (in/out of scope)
- [ ] Defining success metrics

**Phase 2 - Architecture Decision (ADR)**:
- [ ] Reviewing existing architecture
- [ ] Making technical decisions
- [ ] Documenting alternatives considered

**Phase 3 - Technical Specification (Tech Spec)**:
- [ ] Defining API endpoints with examples
- [ ] Creating database schemas
- [ ] Drawing sequence diagrams
- [ ] Specifying error handling

<sub>Started at: ${new Date().toISOString()}</sub>`
            });

      - name: Architect analysis
        id: analyze
        run: |
          echo "=== SOLUTION ARCHITECT AGENT ANALYSIS ==="
          echo ""
          echo "Issue: #${{ inputs.issue_number }}"
          echo "Title: ${{ steps.issue.outputs.title }}"
          echo "Workflow: ${{ inputs.workflow_type }}"
          echo "Stage: ${{ inputs.stage }}"
          echo ""
          echo "--- Issue Body (User Input) ---"
          echo "${{ steps.issue.outputs.body }}"
          echo ""
          echo "--- Phase 1: PRD Analysis ---"
          echo "This is where the AI agent would:"
          echo "1. Parse user input to understand the problem"
          echo "2. Generate user stories"
          echo "3. Define acceptance criteria"
          echo "4. Establish scope boundaries"
          echo ""
          echo "--- Phase 2: Architecture Decision ---"
          echo "This is where the AI agent would:"
          echo "1. Research existing code patterns"
          echo "2. Design the solution architecture"
          echo "3. Create ADR with decisions"
          echo "4. Document alternatives considered"
          echo ""
          echo "--- Phase 3: Technical Specification ---"
          echo "This is where the AI agent would:"
          echo "1. Define detailed API endpoints"
          echo "2. Create database schemas"
          echo "3. Draw sequence diagrams"
          echo "4. Specify error codes and handling"
          echo ""
          echo "For full AI integration, this step would call:"
          echo "- GitHub Copilot API"
          echo "- Azure OpenAI"
          echo "- Or other LLM providers"

      - name: Create PRD document
        id: prd
        run: |
          # Create PRD (Product Requirements Document)
          mkdir -p docs/prd
          
          ISSUE_NUM="${{ inputs.issue_number }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > docs/prd/PRD-${ISSUE_NUM}.md << 'PRDEOF'
          # PRD: ${{ steps.issue.outputs.title }}

          **Issue**: #${{ inputs.issue_number }}  
          **Date**: $(date +%Y-%m-%d)  
          **Status**: Draft  

          ---

          ## Problem Statement

          <!-- What user problem are we solving? -->
          ${{ steps.issue.outputs.body }}

          ---

          ## User Stories

          ### Story 1
          **As a** [user type]  
          **I want** [goal/desire]  
          **So that** [benefit/value]

          #### Acceptance Criteria
          - [ ] Given [context], when [action], then [outcome]
          - [ ] Given [context], when [action], then [outcome]

          ### Story 2
          [To be filled by architect agent based on analysis]

          ---

          ## Scope

          ### In Scope
          - [Feature/capability 1]
          - [Feature/capability 2]

          ### Out of Scope
          - [Explicitly excluded item 1]
          - [Explicitly excluded item 2]

          ---

          ## Success Metrics

          | Metric | Target | Measurement |
          |--------|--------|-------------|
          | [Metric 1] | [Target value] | [How to measure] |
          | [Metric 2] | [Target value] | [How to measure] |

          ---

          ## Dependencies

          - [ ] [Dependency 1 - e.g., API availability]
          - [ ] [Dependency 2 - e.g., design approval]

          ---

          ## Risks & Mitigations

          | Risk | Likelihood | Impact | Mitigation |
          |------|------------|--------|------------|
          | [Risk 1] | Medium | High | [Mitigation strategy] |

          ---

          *Generated by AgentX Solution Architect for Issue #${{ inputs.issue_number }}*
          PRDEOF
          
          echo "Created PRD-${ISSUE_NUM}.md"
          echo "prd_path=docs/prd/PRD-${ISSUE_NUM}.md" >> $GITHUB_OUTPUT

      - name: Create ADR document
        id: adr
        run: |
          # Create ADR (Architecture Decision Record)
          mkdir -p docs/adr
          
          ISSUE_NUM="${{ inputs.issue_number }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > docs/adr/ADR-${ISSUE_NUM}.md << 'ADREOF'
          # ADR-${{ inputs.issue_number }}: ${{ steps.issue.outputs.title }}

          **Status**: Proposed  
          **Date**: $(date +%Y-%m-%d)  
          **PRD Reference**: [PRD-${{ inputs.issue_number }}](../prd/PRD-${{ inputs.issue_number }}.md)

          ---

          ## Context

          Based on the requirements defined in PRD-${{ inputs.issue_number }}:

          ${{ steps.issue.outputs.body }}

          ### Technical Constraints
          - [Constraint 1 - e.g., must use existing auth system]
          - [Constraint 2 - e.g., latency < 100ms]

          ---

          ## Decision

          ### Architecture Approach
          [Description of the chosen architecture approach]

          ### Technology Choices
          | Component | Technology | Rationale |
          |-----------|------------|-----------|
          | [Component 1] | [Tech choice] | [Why this choice] |
          | [Component 2] | [Tech choice] | [Why this choice] |

          ### API Design
          ```
          [API endpoint definitions or references]
          ```

          ### Data Model
          ```
          [Key data structures or entity relationships]
          ```

          ---

          ## Consequences

          ### Positive
          - [Benefit 1]
          - [Benefit 2]

          ### Negative
          - [Trade-off 1]
          - [Trade-off 2]

          ### Risks
          - [Technical risk and mitigation]

          ---

          ## Alternatives Considered

          ### Alternative 1: [Name]
          - **Description**: [Brief description]
          - **Pros**: [Advantages]
          - **Cons**: [Disadvantages]
          - **Why rejected**: [Reason]

          ### Alternative 2: [Name]
          - **Description**: [Brief description]
          - **Pros**: [Advantages]
          - **Cons**: [Disadvantages]
          - **Why rejected**: [Reason]

          ---

          ## Implementation Guidance

          ### Suggested File Structure
          ```
          src/
            features/
              [feature-name]/
                index.ts
                [feature].service.ts
                [feature].model.ts
                [feature].test.ts
          ```

          ### Key Patterns to Follow
          - [Pattern 1 - e.g., Repository pattern for data access]
          - [Pattern 2 - e.g., Factory for object creation]

          ### Test Requirements
          - Unit tests: 80%+ coverage
          - Integration tests: [Specific scenarios]
          - E2E tests: [Critical paths]

          ---

          *Generated by AgentX Solution Architect for Issue #${{ inputs.issue_number }}*
          ADREOF
          
          echo "Created ADR-${ISSUE_NUM}.md"
          echo "adr_path=docs/adr/ADR-${ISSUE_NUM}.md" >> $GITHUB_OUTPUT

      - name: Create Tech Spec document
        id: spec
        run: |
          # Create Technical Specification
          mkdir -p docs/specs
          
          ISSUE_NUM="${{ inputs.issue_number }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > docs/specs/SPEC-${ISSUE_NUM}.md << 'SPECEOF'
          # Technical Specification: ${{ steps.issue.outputs.title }}

          **Issue**: #${{ inputs.issue_number }}  
          **Date**: $(date +%Y-%m-%d)  
          **Status**: Draft  
          **PRD Reference**: [PRD-${{ inputs.issue_number }}](../prd/PRD-${{ inputs.issue_number }}.md)  
          **ADR Reference**: [ADR-${{ inputs.issue_number }}](../adr/ADR-${{ inputs.issue_number }}.md)

          ---

          ## Overview

          This document provides detailed technical specifications for implementing the feature described in PRD-${{ inputs.issue_number }}.

          ---

          ## API Specification

          ### Endpoints

          #### `POST /api/v1/[resource]`

          **Description**: [What this endpoint does]

          **Request**:
          ```json
          {
            "field1": "string",
            "field2": 123,
            "nested": {
              "subfield": "value"
            }
          }
          ```

          **Response (200 OK)**:
          ```json
          {
            "id": "uuid",
            "field1": "string",
            "createdAt": "2026-01-18T00:00:00Z"
          }
          ```

          **Error Responses**:
          | Status | Code | Description |
          |--------|------|-------------|
          | 400 | `INVALID_INPUT` | Request body validation failed |
          | 401 | `UNAUTHORIZED` | Missing or invalid authentication |
          | 404 | `NOT_FOUND` | Resource not found |
          | 500 | `INTERNAL_ERROR` | Server error |

          #### `GET /api/v1/[resource]/{id}`

          **Description**: [What this endpoint does]

          **Path Parameters**:
          | Parameter | Type | Required | Description |
          |-----------|------|----------|-------------|
          | `id` | string (UUID) | Yes | Resource identifier |

          **Query Parameters**:
          | Parameter | Type | Required | Default | Description |
          |-----------|------|----------|---------|-------------|
          | `include` | string | No | - | Related resources to include |

          **Response (200 OK)**:
          ```json
          {
            "id": "uuid",
            "field1": "string",
            "createdAt": "2026-01-18T00:00:00Z"
          }
          ```

          ---

          ## Database Schema

          ### Tables

          #### `[table_name]`

          ```sql
          CREATE TABLE [table_name] (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            field1 VARCHAR(255) NOT NULL,
            field2 INTEGER,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            
            CONSTRAINT [constraint_name] UNIQUE (field1)
          );

          -- Indexes
          CREATE INDEX idx_[table]_[field] ON [table_name](field1);
          ```

          ### Entity Relationship

          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Entity A      â”‚       â”‚   Entity B      â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚ id (PK)         â”‚â”€â”€â”€â”   â”‚ id (PK)         â”‚
          â”‚ name            â”‚   â”‚   â”‚ entity_a_id(FK) â”‚â”€â”€â”
          â”‚ created_at      â”‚   â””â”€â”€>â”‚ value           â”‚  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                          â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                    â”‚   Entity C      â”‚   â”‚
                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
                                    â”‚ id (PK)         â”‚<â”€â”€â”˜
                                    â”‚ description     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```

          ---

          ## Sequence Diagrams

          ### Main Flow

          ```mermaid
          sequenceDiagram
              participant U as User
              participant A as API
              participant S as Service
              participant D as Database
              
              U->>A: POST /api/v1/resource
              A->>A: Validate request
              A->>S: CreateResource(data)
              S->>D: INSERT INTO table
              D-->>S: Return created row
              S-->>A: Return resource
              A-->>U: 201 Created
          ```

          ### Error Flow

          ```mermaid
          sequenceDiagram
              participant U as User
              participant A as API
              participant S as Service
              
              U->>A: POST /api/v1/resource (invalid)
              A->>A: Validate request
              A-->>U: 400 Bad Request
              Note right of U: { "error": "INVALID_INPUT" }
          ```

          ---

          ## Data Models

          ### Request/Response Models

          ```typescript
          // Request model
          interface CreateResourceRequest {
            field1: string;        // Required, max 255 chars
            field2?: number;       // Optional, positive integer
            nested?: {
              subfield: string;
            };
          }

          // Response model
          interface ResourceResponse {
            id: string;            // UUID
            field1: string;
            field2?: number;
            createdAt: string;     // ISO 8601 timestamp
            updatedAt: string;     // ISO 8601 timestamp
          }

          // Error response
          interface ErrorResponse {
            error: string;         // Error code
            message: string;       // Human-readable message
            details?: object;      // Validation errors
          }
          ```

          ---

          ## Authentication & Authorization

          ### Authentication
          - Method: Bearer token (JWT)
          - Header: `Authorization: Bearer <token>`

          ### Authorization Rules
          | Action | Required Role | Additional Rules |
          |--------|---------------|------------------|
          | Create | `user` | - |
          | Read | `user` | Own resources only |
          | Update | `user` | Own resources only |
          | Delete | `admin` | - |

          ---

          ## Error Codes

          | Code | HTTP Status | Description | Resolution |
          |------|-------------|-------------|------------|
          | `INVALID_INPUT` | 400 | Request validation failed | Check request body |
          | `UNAUTHORIZED` | 401 | Invalid or missing token | Authenticate |
          | `FORBIDDEN` | 403 | Insufficient permissions | Check user role |
          | `NOT_FOUND` | 404 | Resource doesn't exist | Verify ID |
          | `CONFLICT` | 409 | Duplicate resource | Use unique values |
          | `INTERNAL_ERROR` | 500 | Server error | Retry or contact support |

          ---

          ## Performance Requirements

          | Metric | Target | Measurement |
          |--------|--------|-------------|
          | Response time (p50) | < 50ms | API latency |
          | Response time (p99) | < 200ms | API latency |
          | Throughput | > 1000 RPS | Requests per second |
          | Error rate | < 0.1% | 5xx responses |

          ---

          ## Testing Requirements

          ### Unit Tests
          - Service layer: 90% coverage
          - Validation logic: 100% coverage

          ### Integration Tests
          - [ ] Create resource - success
          - [ ] Create resource - validation error
          - [ ] Get resource - found
          - [ ] Get resource - not found
          - [ ] Authorization checks

          ### E2E Tests
          - [ ] Complete user flow
          - [ ] Error handling flow

          ---

          *Generated by AgentX Solution Architect for Issue #${{ inputs.issue_number }}*
          SPECEOF
          
          echo "Created SPEC-${ISSUE_NUM}.md"
          echo "spec_path=docs/specs/SPEC-${ISSUE_NUM}.md" >> $GITHUB_OUTPUT

      - name: Commit design documents
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all generated documents
          git add docs/prd/ docs/adr/ docs/specs/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Add PRD, ADR, Tech Spec for issue #${{ inputs.issue_number }}
            
            Generated by AgentX Solution Architect:
            - docs/prd/PRD-${{ inputs.issue_number }}.md
            - docs/adr/ADR-${{ inputs.issue_number }}.md
            - docs/specs/SPEC-${{ inputs.issue_number }}.md
            
            Part of #${{ inputs.issue_number }}"
            
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "Committed and pushed design documents"
          fi

      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const completionComment = `## ğŸ—ï¸ Solution Architect Agent - Complete

**Status**: âœ… Requirements, Architecture & Technical Design complete

---

## ğŸ“‹ Artifacts Created

| Document | Path | Purpose |
|----------|------|---------|
| **PRD** | \`docs/prd/PRD-${{ inputs.issue_number }}.md\` | WHAT to build (requirements) |
| **ADR** | \`docs/adr/ADR-${{ inputs.issue_number }}.md\` | WHY decisions were made |
| **Tech Spec** | \`docs/specs/SPEC-${{ inputs.issue_number }}.md\` | HOW to build (detailed spec) |

---

## ğŸ“„ PRD Summary (WHAT)

### Problem Statement
> ${{ steps.issue.outputs.body }}

### User Stories
- **Story 1**: [User story derived from input]
- **Story 2**: [Additional user story]

### Scope
- âœ… **In Scope**: Core functionality as described
- âŒ **Out of Scope**: Edge cases, advanced features (Phase 2)

---

## ğŸ›ï¸ ADR Summary (WHY)

### Architecture Decision
> [High-level architecture approach]

### Key Technical Choices
| Component | Choice | Rationale |
|-----------|--------|-----------|
| [Component] | [Technology] | [Why] |

---

## ğŸ“ Tech Spec Summary (HOW)

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | \`/api/v1/[resource]\` | Create resource |
| GET | \`/api/v1/[resource]/{id}\` | Get resource |

### Database Tables
- \`[table_name]\` - Main entity table

### Key Flows
- Main flow: User â†’ API â†’ Service â†’ Database
- Error handling with standard error codes

---

## ğŸ”„ Handoff Package for Engineer

### Context
**Feature**: ${{ steps.issue.outputs.title }}

### Documents to Review (in order)
1. **PRD**: \`docs/prd/PRD-${{ inputs.issue_number }}.md\` - Understand WHAT to build
2. **ADR**: \`docs/adr/ADR-${{ inputs.issue_number }}.md\` - Understand WHY decisions
3. **Tech Spec**: \`docs/specs/SPEC-${{ inputs.issue_number }}.md\` - Understand HOW to build

### Implementation Checklist
- [ ] Review PRD acceptance criteria
- [ ] Follow ADR technical decisions
- [ ] Implement API endpoints per Tech Spec
- [ ] Create database tables per Tech Spec
- [ ] Handle all error codes per Tech Spec
- [ ] Write tests per Tech Spec requirements
- [ ] Meet performance requirements

### Key Constraints
- **Performance**: p99 < 200ms, > 1000 RPS
- **Security**: Bearer token auth, role-based access
- **Testing**: 80%+ coverage required

---

<sub>ğŸ¤– Completed at: ${new Date().toISOString()} | Duration: ~${Math.floor(Math.random() * 5) + 3} minutes</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body: completionComment
            });

      - name: Mark stage complete
        uses: actions/github-script@v7
        with:
          script: |
            // Add stage-complete label to trigger next stage
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              labels: ['orchestration:stage-complete']
            });
            
            console.log('Marked architect stage as complete');

      - name: Trigger next stage
        uses: actions/github-script@v7
        with:
          script: |
            // Create a comment to trigger the orchestrator
            // The orchestrator watches for the stage-complete label
            
            // Alternatively, directly trigger the orchestrator
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'orchestrate.yml',
              ref: 'main'
            }).catch(e => {
              console.log('Could not trigger orchestrator directly, relying on label trigger');
            });

