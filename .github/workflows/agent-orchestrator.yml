# Agent Orchestrator - Simplified
# Routes issues to agents based on type labels
# Status tracked via GitHub Projects V2 (not labels)

name: Agent Orchestrator

on:
  issues:
    types: [labeled, opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

permissions:
  issues: write
  contents: write

jobs:
  route:
    name: Route Issue to Agent
    runs-on: ubuntu-latest
    outputs:
      agent: ${{ steps.route.outputs.agent }}
      issue_number: ${{ steps.route.outputs.issue_number }}
    steps:
      - name: Determine Agent
        id: route
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue number
            const issueNumber = context.eventName === 'workflow_dispatch'
              ? parseInt(context.payload.inputs.issue_number)
              : context.payload.issue?.number;
            
            if (!issueNumber) {
              console.log('‚ùå No issue to process');
              return;
            }
            
            // Get issue details
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const labels = issue.labels.map(l => l.name);
            console.log(`Issue #${issueNumber}: ${labels.join(', ')}`);
            
            // Route based on AGENTS.md workflow:
            // type:epic ‚Üí PM
            // type:feature/spike ‚Üí Architect
            // type:story/bug ‚Üí Engineer
            // needs:ux ‚Üí UX Designer (before others)
            let agent = null;
            
            if (labels.includes('type:epic')) {
              agent = 'pm';
            } else if (labels.includes('needs:ux')) {
              agent = 'ux';
            } else if (labels.includes('type:feature') || labels.includes('type:spike')) {
              agent = 'architect';
            } else if (labels.includes('type:story') || labels.includes('type:bug') || labels.includes('type:docs')) {
              agent = 'engineer';
            }
            
            core.setOutput('agent', agent || '');
            core.setOutput('issue_number', issueNumber);
            console.log(agent ? `‚úÖ Routing to: ${agent}` : '‚è∏Ô∏è No routing needed');

  # Product Manager: Creates PRD for Epics
  pm:
    name: üìã Product Manager
    needs: route
    if: needs.route.outputs.agent == 'pm'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create PRD Scaffold
        run: |
          mkdir -p docs/prd
          ISSUE="${{ needs.route.outputs.issue_number }}"
          if [ ! -f "docs/prd/PRD-${ISSUE}.md" ]; then
            cp .github/templates/PRD-TEMPLATE.md "docs/prd/PRD-${ISSUE}.md"
            sed -i "s/{epic-id}/${ISSUE}/g" "docs/prd/PRD-${ISSUE}.md"
            echo "‚úÖ Created PRD scaffold"
          else
            echo "‚è≠Ô∏è PRD already exists"
          fi
      
      - name: Commit & Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ needs.route.outputs.issue_number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/prd/
          git diff --cached --quiet || git commit -m "docs: scaffold PRD for Epic #${ISSUE}"
          git push || true
          gh issue comment ${ISSUE} --body "üìã **PM Agent**: PRD scaffold created at \`docs/prd/PRD-${ISSUE}.md\`

Status: Update to **Ready** in Projects board when complete."

  # UX Designer: Creates UX design for needs:ux issues
  ux:
    name: üé® UX Designer
    needs: route
    if: needs.route.outputs.agent == 'ux'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create UX Scaffold
        run: |
          mkdir -p docs/ux
          ISSUE="${{ needs.route.outputs.issue_number }}"
          if [ ! -f "docs/ux/UX-${ISSUE}.md" ]; then
            cp .github/templates/UX-TEMPLATE.md "docs/ux/UX-${ISSUE}.md"
            sed -i "s/{feature-id}/${ISSUE}/g" "docs/ux/UX-${ISSUE}.md"
            echo "‚úÖ Created UX scaffold"
          else
            echo "‚è≠Ô∏è UX design already exists"
          fi
      
      - name: Commit & Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ needs.route.outputs.issue_number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ux/
          git diff --cached --quiet || git commit -m "docs: scaffold UX design for #${ISSUE}"
          git push || true
          gh issue comment ${ISSUE} --body "üé® **UX Agent**: Design scaffold created at \`docs/ux/UX-${ISSUE}.md\`

Status: Update to **Ready** in Projects board when complete."

  # Architect: Creates ADR + Spec for Features/Spikes
  architect:
    name: üèóÔ∏è Architect
    needs: route
    if: needs.route.outputs.agent == 'architect'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create ADR + Spec Scaffold
        run: |
          mkdir -p docs/adr docs/specs
          ISSUE="${{ needs.route.outputs.issue_number }}"
          
          if [ ! -f "docs/adr/ADR-${ISSUE}.md" ]; then
            cp .github/templates/ADR-TEMPLATE.md "docs/adr/ADR-${ISSUE}.md"
            sed -i "s/{epic-id}/${ISSUE}/g" "docs/adr/ADR-${ISSUE}.md"
          fi
          
          if [ ! -f "docs/specs/SPEC-${ISSUE}.md" ]; then
            cp .github/templates/SPEC-TEMPLATE.md "docs/specs/SPEC-${ISSUE}.md"
            sed -i "s/{feature-id}/${ISSUE}/g" "docs/specs/SPEC-${ISSUE}.md"
          fi
      
      - name: Commit & Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ needs.route.outputs.issue_number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/adr/ docs/specs/
          git diff --cached --quiet || git commit -m "docs: scaffold ADR + Spec for #${ISSUE}"
          git push || true
          gh issue comment ${ISSUE} --body "üèóÔ∏è **Architect Agent**: Scaffolds created:
- ADR: \`docs/adr/ADR-${ISSUE}.md\`
- Spec: \`docs/specs/SPEC-${ISSUE}.md\`

Status: Update to **Ready** in Projects board when complete."

  # Engineer: Acknowledges story/bug assignment
  engineer:
    name: üîß Engineer
    needs: route
    if: needs.route.outputs.agent == 'engineer'
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge Assignment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ needs.route.outputs.issue_number }}"
          gh issue comment ${ISSUE} --repo ${{ github.repository }} --body "üîß **Engineer Agent**: Ready for implementation.

**Workflow:**
1. Move status to **In Progress** in Projects board
2. Implement code with tests (‚â•80% coverage)
3. Move status to **In Review** when done

See \`docs/specs/\` for technical requirements."
