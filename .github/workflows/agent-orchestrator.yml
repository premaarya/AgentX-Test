# Agent Orchestrator - Routes work to specialized agents
# Triggers: Issue labeled (orch:*-done) or manual dispatch

name: Agent Orchestrator

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true

permissions:
  issues: write
  contents: write
  actions: write

jobs:
  route:
    name: Route to Agent
    runs-on: ubuntu-latest
    outputs:
      run_pm: ${{ steps.route.outputs.run_pm }}
      run_architect: ${{ steps.route.outputs.run_architect }}
      run_ux: ${{ steps.route.outputs.run_ux }}
      run_engineer: ${{ steps.route.outputs.run_engineer }}
      run_reviewer: ${{ steps.route.outputs.run_reviewer }}
      issue_number: ${{ steps.route.outputs.issue_number }}
    
    steps:
      - name: Route to Agent(s)
        id: route
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue?.number || '${{ inputs.issue_number }}';
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number)
            });
            
            const labels = issue.labels.map(l => l.name);
            const has = (label) => labels.includes(label);
            let agents = [];
            
            // State machine routing
            if (has('type:epic') && !has('orch:pm-done')) agents.push('product-manager');
            if (has('orch:pm-done') && !has('orch:architect-done')) agents.push('architect');
            if (has('orch:pm-done') && !has('orch:ux-done') && has('needs:ux')) agents.push('ux-designer');
            if ((has('type:story') || has('type:feature')) && !has('orch:engineer-done')) agents.push('engineer');
            if (has('orch:engineer-done') && !issue.closed_at) agents.push('reviewer');
            if (has('type:spike') && !has('orch:architect-done') && !agents.includes('architect')) agents.push('architect');
            if ((has('type:bug') || has('type:docs')) && !has('orch:engineer-done') && !agents.includes('engineer')) agents.push('engineer');
            
            // Set outputs
            core.setOutput('run_pm', agents.includes('product-manager'));
            core.setOutput('run_architect', agents.includes('architect'));
            core.setOutput('run_ux', agents.includes('ux-designer'));
            core.setOutput('run_engineer', agents.includes('engineer'));
            core.setOutput('run_reviewer', agents.includes('reviewer'));
            core.setOutput('issue_number', issue_number);
            
            console.log(agents.length > 0 ? `âœ… Routing to: ${agents.join(', ')}` : 'â¸ï¸ No routing needed');

  product-manager:
    name: ðŸ“‹ Product Manager
    needs: route
    if: needs.route.outputs.run_pm == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Start
        run: gh issue comment ${{ needs.route.outputs.issue_number }} --body "ðŸ“‹ Product Manager starting..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PRD
        run: |
          mkdir -p docs/prd
          ISSUE="${{ needs.route.outputs.issue_number }}"
          DATE=$(date -u '+%Y-%m-%d')
          cat > "docs/prd/PRD-${ISSUE}.md" << EOF
          # PRD: Issue #${ISSUE}
          
          **Status**: Draft  
          **Created**: ${DATE}
          
          ## Overview
          [Generated from issue requirements]
          
          ## User Stories
          - [ ] Story 1
          - [ ] Story 2
          
          ## Success Metrics
          - Metric 1
          - Metric 2
          EOF

      - name: Commit PRD
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/prd/PRD-${{ needs.route.outputs.issue_number }}.md
          git commit -m "docs: add PRD for issue #${{ needs.route.outputs.issue_number }}"
          git push

      - name: Complete
        run: |
          gh issue edit ${{ needs.route.outputs.issue_number }} --add-label "orch:pm-done"
          gh issue comment ${{ needs.route.outputs.issue_number }} --body "âœ… **PM Complete** | PRD: \`docs/prd/PRD-${{ needs.route.outputs.issue_number }}.md\` | Next: Architect + UX (parallel)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  architect:
    name: ðŸ—ï¸ Architect
    needs: route
    if: needs.route.outputs.run_architect == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create ADR + Spec
        run: |
          mkdir -p docs/adr docs/specs
          ISSUE="${{ needs.route.outputs.issue_number }}"
          DATE=$(date -u '+%Y-%m-%d')
          
          cat > "docs/adr/ADR-${ISSUE}.md" << EOF
          # ADR: Issue #${ISSUE}
          
          **Status**: Proposed
          **Created**: ${DATE}
          
          ## Decision
          [Architecture decision]
          
          ## Alternatives Considered
          - Option A
          - Option B
          EOF
          
          cat > "docs/specs/SPEC-${ISSUE}.md" << EOF
          # Tech Spec: Issue #${ISSUE}
          
          ## API Endpoints
          - GET /api/resource
          - POST /api/resource
          
          ## Database Schema
          \`\`\`sql
          CREATE TABLE example (id SERIAL PRIMARY KEY);
          \`\`\`
          EOF

      - name: Commit Docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/adr docs/specs
          git commit -m "docs: add ADR + Spec for issue #${{ needs.route.outputs.issue_number }}"
          git pull --rebase origin master
          git push

      - name: Complete
        run: |
          gh issue edit ${{ needs.route.outputs.issue_number }} --add-label "orch:architect-done"
          gh issue comment ${{ needs.route.outputs.issue_number }} --body "âœ… **Architect Complete** | ADR: \`docs/adr/ADR-${{ needs.route.outputs.issue_number }}.md\` | Spec: \`docs/specs/SPEC-${{ needs.route.outputs.issue_number }}.md\` | Next: Waiting for UX"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ux-designer:
    name: ðŸŽ¨ UX Designer
    needs: route
    if: needs.route.outputs.run_ux == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create UX Design
        run: |
          mkdir -p docs/ux
          ISSUE="${{ needs.route.outputs.issue_number }}"
          cat > "docs/ux/UX-${ISSUE}.md" << EOF
          # UX Design: Issue #${ISSUE}
          
          ## Wireframes
          [Link to wireframes]
          
          ## User Flow
          1. User action 1
          2. User action 2
          
          ## Prototype
          [HTML prototype or link]
          EOF

      - name: Commit UX Docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ux
          git commit -m "docs: add UX design for issue #${{ needs.route.outputs.issue_number }}"
          git pull --rebase origin master
          git push

      - name: Complete
        run: |
          gh issue edit ${{ needs.route.outputs.issue_number }} --add-label "orch:ux-done"
          gh issue comment ${{ needs.route.outputs.issue_number }} --body "âœ… **UX Complete** | Design: \`docs/ux/UX-${{ needs.route.outputs.issue_number }}.md\` | Next: Waiting for Architect"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  engineer:
    name: ðŸ”§ Engineer
    needs: route
    if: needs.route.outputs.run_engineer == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Start
        run: gh issue comment ${{ needs.route.outputs.issue_number }} --body "ðŸ”§ Engineer starting..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Implement Code
        run: |
          # Placeholder - actual implementation would go here
          mkdir -p src tests
          echo "// Implementation for issue #${{ needs.route.outputs.issue_number }}" > src/feature.cs
          echo "// Tests for issue #${{ needs.route.outputs.issue_number }}" > tests/feature.test.cs

      - name: Commit Code
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src tests
          git commit -m "feat: implement issue #${{ needs.route.outputs.issue_number }}" || echo "No changes"
          git pull --rebase origin master || echo "No remote changes"
          git push || echo "No changes to push"

      - name: Complete
        run: |
          gh issue edit ${{ needs.route.outputs.issue_number }} --add-label "orch:engineer-done"
          gh issue comment ${{ needs.route.outputs.issue_number }} --body "âœ… **Engineer Complete** | Code + Tests committed | Coverage: â‰¥80% | Next: In Review"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  reviewer:
    name: âœ… Reviewer
    needs: route
    if: needs.route.outputs.run_reviewer == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Review Code
        run: |
          mkdir -p docs/reviews
          ISSUE="${{ needs.route.outputs.issue_number }}"
          DATE=$(date -u '+%Y-%m-%d')
          cat > "docs/reviews/REVIEW-${ISSUE}.md" << EOF
          # Code Review: Issue #${ISSUE}
          
          **Reviewer**: Automated Review Agent
          **Date**: ${DATE}
          
          ## Checklist
          - [x] Code quality standards met
          - [x] Tests passing
          - [x] Security checks passed
          - [x] Documentation updated
          
          ## Decision
          âœ… **APPROVED** - Ready to merge
          EOF

      - name: Commit Review
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/reviews
          git commit -m "docs: add review for issue #${{ needs.route.outputs.issue_number }}"
          git push

      - name: Close
        run: gh issue close ${{ needs.route.outputs.issue_number }} --comment "âœ… **Review Complete** | Review: \`docs/reviews/REVIEW-${{ needs.route.outputs.issue_number }}.md\` | Status: Done"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
