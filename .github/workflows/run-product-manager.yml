# Product Manager Agent Workflow
# Triggered by type:epic issues to create PRD and backlog
# Part of AgentX Multi-Agent Orchestration

name: Run Product Manager Agent

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body content'
        required: true
        type: string

  # Can also be called from orchestrator
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body content'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  ISSUE_NUMBER: ${{ inputs.issue_number }}
  ISSUE_TITLE: ${{ inputs.issue_title }}
  ISSUE_BODY: ${{ inputs.issue_body }}

jobs:
  product-manager:
    name: Product Manager - PRD & Backlog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Issue Status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ env.ISSUE_NUMBER }} \
            --add-label "stage:product-manager,status:in-progress" \
            --remove-label "status:ready"
          
          gh issue comment ${{ env.ISSUE_NUMBER }} --body "## ðŸŽ¯ Product Manager Started

          **Agent**: Product Manager
          **Task**: Creating PRD and backlog breakdown
          **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### What I'll Do
          1. Analyze requirements from issue
          2. Create PRD document
          3. Break down into Epic â†’ Features â†’ Stories
          4. Create GitHub Issues with proper hierarchy
          5. Hand off to Architect for technical design"

      - name: Create PRD Directory
        run: mkdir -p docs/prd

      - name: Generate PRD Document
        run: |
          cat > "docs/prd/PRD-${{ env.ISSUE_NUMBER }}.md" << 'PRDEOF'
          # PRD: ${{ env.ISSUE_TITLE }}

          **Issue**: #${{ env.ISSUE_NUMBER }}  
          **Status**: Draft  
          **Author**: Product Manager Agent  
          **Date**: $(date -u '+%Y-%m-%d')

          ---

          ## 1. Overview

          ### 1.1 Problem Statement

          ${{ env.ISSUE_BODY }}

          ### 1.2 Target Users

          | Persona | Description | Key Needs |
          |---------|-------------|-----------|
          | Primary User | [To be defined based on analysis] | [Key needs] |
          | Secondary User | [To be defined] | [Key needs] |

          ### 1.3 Success Metrics

          | Metric | Target | Measurement |
          |--------|--------|-------------|
          | User Adoption | TBD | Active users |
          | Task Completion | TBD | Success rate |
          | User Satisfaction | TBD | NPS/CSAT |

          ---

          ## 2. Requirements

          ### 2.1 Functional Requirements

          | ID | Requirement | Priority | Notes |
          |----|-------------|----------|-------|
          | FR-1 | [Derived from issue description] | P1 | Core functionality |
          | FR-2 | [Additional requirement] | P2 | Enhancement |

          ### 2.2 Non-Functional Requirements

          | ID | Requirement | Target |
          |----|-------------|--------|
          | NFR-1 | Performance | < 200ms response time |
          | NFR-2 | Availability | 99.9% uptime |
          | NFR-3 | Security | Authentication required |
          | NFR-4 | Accessibility | WCAG 2.1 AA |

          ### 2.3 Out of Scope

          - Features not mentioned in original request
          - Platform-specific implementations (unless specified)
          - Third-party integrations (unless specified)

          ---

          ## 3. User Stories

          ### Epic: ${{ env.ISSUE_TITLE }}

          #### Feature 1: Core Functionality

          | ID | As a... | I want... | So that... | Priority |
          |----|---------|-----------|------------|----------|
          | US-1.1 | user | [primary capability] | [primary benefit] | P0 |
          | US-1.2 | user | [secondary capability] | [secondary benefit] | P1 |

          **Acceptance Criteria (US-1.1)**:
          - [ ] User can [action 1]
          - [ ] System responds with [expected result]
          - [ ] Error handling for [edge case]

          #### Feature 2: Supporting Functionality

          | ID | As a... | I want... | So that... | Priority |
          |----|---------|-----------|------------|----------|
          | US-2.1 | user | [capability] | [benefit] | P1 |

          **Acceptance Criteria (US-2.1)**:
          - [ ] [Criterion 1]
          - [ ] [Criterion 2]

          ---

          ## 4. UX Requirements

          ### 4.1 Key User Flows

          ```
          [Start] â†’ [Action 1] â†’ [Decision] â†’ [Action 2] â†’ [End]
          ```

          ### 4.2 UI Components Needed

          - [ ] [Component 1] - [Purpose]
          - [ ] [Component 2] - [Purpose]

          ### 4.3 Accessibility Requirements

          - WCAG 2.1 AA compliance
          - Keyboard navigation support
          - Screen reader compatibility
          - Sufficient color contrast

          ---

          ## 5. Dependencies & Risks

          ### 5.1 Dependencies

          | Dependency | Owner | Status | Impact |
          |------------|-------|--------|--------|
          | [System/API] | [Team] | TBD | [Impact if delayed] |

          ### 5.2 Risks

          | Risk | Probability | Impact | Mitigation |
          |------|-------------|--------|------------|
          | [Risk 1] | Medium | High | [Strategy] |
          | [Risk 2] | Low | Medium | [Strategy] |

          ---

          ## 6. Implementation Notes

          ### For Architect
          - Consider scalability for [aspect]
          - Evaluate [technology choice] vs [alternative]
          - Design API for [integration need]

          ### For UX Designer
          - Focus on [key user flow]
          - Consider [accessibility need]
          - Research [competitor/pattern]

          ---

          ## Appendix

          ### A. Original Request

          ```
          ${{ env.ISSUE_BODY }}
          ```

          ### B. Related Documents

          - ADR: To be created by Architect
          - Tech Spec: To be created by Architect
          - UX Design: To be created by UX Designer (if needed)

          PRDEOF

      - name: Create Epic Issue
        id: create_epic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EPIC_BODY=$(cat << 'EPICEOF'
          ## Overview
          
          Epic for: ${{ env.ISSUE_TITLE }}
          
          ### Problem Statement
          ${{ env.ISSUE_BODY }}
          
          ### PRD
          ðŸ“„ See: `docs/prd/PRD-${{ env.ISSUE_NUMBER }}.md`
          
          ---
          
          ## Features
          - [ ] Feature 1: Core Functionality (issue to be created)
          - [ ] Feature 2: Supporting Functionality (issue to be created)
          
          ## Success Metrics
          - User adoption target: TBD
          - Task completion rate: TBD
          
          ## Parent Issue
          Original Request: #${{ env.ISSUE_NUMBER }}
          EPICEOF
          )
          
          # Strip [Epic] prefix if already present in title to avoid duplication
          TITLE="${{ env.ISSUE_TITLE }}"
          TITLE="${TITLE#\[Epic\] }"
          
          EPIC_RESULT=$(gh issue create \
            --title "[Epic] $TITLE" \
            --body "$EPIC_BODY" \
            --label "type:epic,priority:p1,status:ready" 2>&1)
          
          # Extract issue number from URL
          EPIC_ID=$(echo "$EPIC_RESULT" | grep -oE '[0-9]+$')
          
          echo "epic_id=$EPIC_ID" >> $GITHUB_OUTPUT
          echo "Created Epic #$EPIC_ID"

      - name: Create Feature 1 Issue
        id: create_feature1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EPIC_ID: ${{ steps.create_epic.outputs.epic_id }}
        run: |
          FEATURE_BODY=$(cat << 'FEATUREOF'
          ## Description
          
          Core functionality for: ${{ env.ISSUE_TITLE }}
          
          This feature implements the primary capabilities requested.
          
          ---
          
          ## Parent
          ðŸŽ¯ Epic: #${{ env.EPIC_ID }}
          
          ## User Stories
          - [ ] Story 1: Primary capability (to be created)
          - [ ] Story 2: Secondary capability (to be created)
          
          ## Acceptance Criteria
          - [ ] All user stories completed
          - [ ] Technical design (ADR) approved
          - [ ] All tests passing
          - [ ] Code review approved
          
          ## Technical Notes
          See PRD: `docs/prd/PRD-${{ env.ISSUE_NUMBER }}.md`
          FEATUREOF
          )
          
          # Strip [Epic] prefix if present in title
          TITLE="${{ env.ISSUE_TITLE }}"
          TITLE="${TITLE#\[Epic\] }"
          
          FEATURE_RESULT=$(gh issue create \
            --title "[Feature] Core Functionality - $TITLE" \
            --body "$FEATURE_BODY" \
            --label "type:feature,priority:p1,status:ready" 2>&1)
          
          FEATURE_ID=$(echo "$FEATURE_RESULT" | grep -oE '[0-9]+$')
          
          echo "feature1_id=$FEATURE_ID" >> $GITHUB_OUTPUT
          echo "Created Feature #$FEATURE_ID"

      - name: Create Story 1 Issue
        id: create_story1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FEATURE_ID: ${{ steps.create_feature1.outputs.feature1_id }}
        run: |
          STORY_BODY=$(cat << 'STORYEOF'
          ## User Story
          
          **As a** user  
          **I want** the primary capability from this feature  
          **So that** I can achieve the main benefit
          
          ---
          
          ## Parent
          ðŸ“¦ Feature: #${{ env.FEATURE_ID }}
          
          ## Acceptance Criteria
          - [ ] User can perform primary action
          - [ ] System provides expected response
          - [ ] Error cases handled gracefully
          - [ ] Performance within acceptable limits
          
          ## UX Required
          âš ï¸ This story likely requires UX design. Add `needs:ux` label if UI work needed.
          
          ## Technical Notes
          - Consider API design for this capability
          - Ensure proper input validation
          - Add comprehensive test coverage
          STORYEOF
          )
          
          STORY_RESULT=$(gh issue create \
            --title "[Story] Primary User Capability" \
            --body "$STORY_BODY" \
            --label "type:story,priority:p1,status:ready,needs:ux" 2>&1)
          
          STORY_ID=$(echo "$STORY_RESULT" | grep -oE '[0-9]+$')
          
          echo "story1_id=$STORY_ID" >> $GITHUB_OUTPUT
          echo "Created Story #$STORY_ID"

      - name: Create Story 2 Issue
        id: create_story2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FEATURE_ID: ${{ steps.create_feature1.outputs.feature1_id }}
        run: |
          STORY_BODY=$(cat << 'STORYEOF'
          ## User Story
          
          **As a** user  
          **I want** a secondary capability  
          **So that** I can have enhanced functionality
          
          ---
          
          ## Parent
          ðŸ“¦ Feature: #${{ env.FEATURE_ID }}
          
          ## Acceptance Criteria
          - [ ] Secondary action available
          - [ ] Integrates with primary capability
          - [ ] Proper error handling
          
          ## UX Required
          No - this is backend/API work
          
          ## Technical Notes
          - May depend on Story 1 completion
          - Consider caching for performance
          STORYEOF
          )
          
          STORY_RESULT=$(gh issue create \
            --title "[Story] Secondary Capability" \
            --body "$STORY_BODY" \
            --label "type:story,priority:p2,status:ready" 2>&1)
          
          STORY_ID=$(echo "$STORY_RESULT" | grep -oE '[0-9]+$')
          
          echo "story2_id=$STORY_ID" >> $GITHUB_OUTPUT
          echo "Created Story #$STORY_ID"

      - name: Update Epic with Issue Links
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EPIC_ID: ${{ steps.create_epic.outputs.epic_id }}
          FEATURE1_ID: ${{ steps.create_feature1.outputs.feature1_id }}
          STORY1_ID: ${{ steps.create_story1.outputs.story1_id }}
          STORY2_ID: ${{ steps.create_story2.outputs.story2_id }}
        run: |
          UPDATED_BODY=$(cat << UPDATEEOF
          ## Overview
          
          Epic for: ${{ env.ISSUE_TITLE }}
          
          ### Problem Statement
          ${{ env.ISSUE_BODY }}
          
          ### PRD
          ðŸ“„ See: \`docs/prd/PRD-${{ env.ISSUE_NUMBER }}.md\`
          
          ---
          
          ## Features
          - [ ] #${{ env.FEATURE1_ID }} - Core Functionality
          
          ## User Stories
          - [ ] #${{ env.STORY1_ID }} - Primary User Capability (needs UX)
          - [ ] #${{ env.STORY2_ID }} - Secondary Capability
          
          ## Success Metrics
          - User adoption target: TBD
          - Task completion rate: TBD
          
          ## Parent Issue
          Original Request: #${{ env.ISSUE_NUMBER }}
          UPDATEEOF
          )
          
          gh issue edit ${{ env.EPIC_ID }} --body "$UPDATED_BODY"

      - name: Update Feature with Story Links
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EPIC_ID: ${{ steps.create_epic.outputs.epic_id }}
          FEATURE_ID: ${{ steps.create_feature1.outputs.feature1_id }}
          STORY1_ID: ${{ steps.create_story1.outputs.story1_id }}
          STORY2_ID: ${{ steps.create_story2.outputs.story2_id }}
        run: |
          UPDATED_BODY=$(cat << UPDATEEOF
          ## Description
          
          Core functionality for: ${{ env.ISSUE_TITLE }}
          
          This feature implements the primary capabilities requested.
          
          ---
          
          ## Parent
          ðŸŽ¯ Epic: #${{ env.EPIC_ID }}
          
          ## User Stories
          - [ ] #${{ env.STORY1_ID }} - Primary User Capability (needs UX)
          - [ ] #${{ env.STORY2_ID }} - Secondary Capability
          
          ## Acceptance Criteria
          - [ ] All user stories completed
          - [ ] Technical design (ADR) approved
          - [ ] All tests passing
          - [ ] Code review approved
          
          ## Technical Notes
          See PRD: \`docs/prd/PRD-${{ env.ISSUE_NUMBER }}.md\`
          UPDATEEOF
          )
          
          gh issue edit ${{ env.FEATURE_ID }} --body "$UPDATED_BODY"

      - name: Commit PRD Document
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/prd/
          git commit -m "docs: Add PRD for issue #${{ env.ISSUE_NUMBER }}

          - Created PRD-${{ env.ISSUE_NUMBER }}.md
          - Problem statement and requirements
          - User stories and acceptance criteria
          - UX and technical notes
          
          Part of #${{ env.ISSUE_NUMBER }}" || echo "No changes to commit"
          
          git push || echo "Nothing to push"

      - name: Post Completion Summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EPIC_ID: ${{ steps.create_epic.outputs.epic_id }}
          FEATURE1_ID: ${{ steps.create_feature1.outputs.feature1_id }}
          STORY1_ID: ${{ steps.create_story1.outputs.story1_id }}
          STORY2_ID: ${{ steps.create_story2.outputs.story2_id }}
        run: |
          gh issue comment ${{ env.ISSUE_NUMBER }} --body "## âœ… Product Manager Complete

          ### PRD Created
          ðŸ“„ **Document**: \`docs/prd/PRD-${{ env.ISSUE_NUMBER }}.md\`

          ### Backlog Created

          | Type | Issue | Title | Labels |
          |------|-------|-------|--------|
          | ðŸŽ¯ Epic | #${{ env.EPIC_ID }} | Epic: ${{ env.ISSUE_TITLE }} | \`type:epic\` |
          | ðŸ“¦ Feature | #${{ env.FEATURE1_ID }} | Core Functionality | \`type:feature\` |
          | ðŸ“ Story | #${{ env.STORY1_ID }} | Primary User Capability | \`type:story,needs:ux\` |
          | ðŸ“ Story | #${{ env.STORY2_ID }} | Secondary Capability | \`type:story\` |

          ### Issue Hierarchy
          \`\`\`
          ðŸŽ¯ Epic #${{ env.EPIC_ID }}
          â””â”€â”€ ðŸ“¦ Feature #${{ env.FEATURE1_ID }} - Core Functionality
              â”œâ”€â”€ ðŸ“ Story #${{ env.STORY1_ID }} - Primary Capability (needs UX)
              â””â”€â”€ ðŸ“ Story #${{ env.STORY2_ID }} - Secondary Capability
          \`\`\`

          ### Next Steps
          
          | Issue | Next Agent | Trigger |
          |-------|------------|---------|
          | #${{ env.FEATURE1_ID }} | **Architect** | \`type:feature\` triggers technical design |
          | #${{ env.STORY1_ID }} | **UX Designer** | \`needs:ux\` triggers UX design first |
          | #${{ env.STORY2_ID }} | **Architect** | \`type:story\` triggers technical design |

          ---
          
          **Handoff**: Features and stories will automatically trigger their respective agents.
          
          ðŸŽ¯ **PM = WHAT** (complete) â†’ ðŸ—ï¸ **Architect = HOW** (next)"

      - name: Update Issue Labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ env.ISSUE_NUMBER }} \
            --add-label "stage:product-manager-done" \
            --remove-label "stage:product-manager,status:in-progress" \
            --add-label "status:done"

      - name: Trigger Next Stage
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Product Manager complete. Features/Stories will trigger next agents automatically."
          echo "- Features trigger: Architect"
          echo "- Stories with needs:ux trigger: UX Designer"
          echo "- Stories without needs:ux trigger: Architect"
