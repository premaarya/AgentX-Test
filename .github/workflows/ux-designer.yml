# Run UX Designer Agent
# Triggered by orchestrator to perform UX design tasks
# Produces wireframes, user flows, and UX research documents
# Part of AgentX Phase 1 MVP
# Note: Workflow runs only via workflow_dispatch. GitHub may show phantom 'failure' on push - ignore these.

name: Run UX Designer Agent

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string
      workflow_type:
        description: 'Type of workflow (ux, feature with needs:ux, etc.)'
        required: true
        type: string
      stage:
        description: 'Current stage number'
        required: true
        type: string

jobs:
  ux-designer:
    name: ğŸ¨ UX Designer Agent
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get issue context
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}')
            });
            
            // Get comments for additional context
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}')
            });
            
            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body || '');
            core.setOutput('labels', issue.data.labels.map(l => l.name).join(','));
            
            // Extract any previous agent outputs from comments
            const agentComments = comments.data.filter(c => 
              c.body.includes('## ğŸ¨ UX Designer') || 
              c.body.includes('## ğŸ—ï¸ Architect')
            );
            
            if (agentComments.length > 0) {
              core.setOutput('previous_context', agentComments.map(c => c.body).join('\n---\n'));
            } else {
              core.setOutput('previous_context', 'No previous agent context');
            }

      - name: Post start comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body: `## ğŸ¨ UX Designer Agent - Working...

            **Task**: Creating user experience design artifacts

            **Phase 1 - User Research**:
            - [ ] Analyzing user needs from issue description
            - [ ] Identifying user personas
            - [ ] Defining user goals and pain points

            **Phase 2 - User Flows**:
            - [ ] Mapping primary user journey
            - [ ] Identifying decision points
            - [ ] Documenting happy path and edge cases

            **Phase 3 - Wireframes**:
            - [ ] Creating low-fidelity wireframes
            - [ ] Defining component layout
            - [ ] Annotating interactions

            <sub>Started at: ${new Date().toISOString()}</sub>`
            });

      - name: UX analysis
        id: analyze
        run: |
          echo "=== UX DESIGNER AGENT ANALYSIS ==="
          echo ""
          echo "Issue: #${{ inputs.issue_number }}"
          echo "Title: ${{ steps.issue.outputs.title }}"
          echo "Workflow: ${{ inputs.workflow_type }}"
          echo "Stage: ${{ inputs.stage }}"
          echo ""
          echo "--- Issue Body (User Input) ---"
          echo "${{ steps.issue.outputs.body }}"
          echo ""
          echo "--- Phase 1: User Research ---"
          echo "This is where the AI agent would:"
          echo "1. Identify target users"
          echo "2. Define user personas"
          echo "3. Understand user goals"
          echo ""
          echo "--- Phase 2: User Flows ---"
          echo "This is where the AI agent would:"
          echo "1. Map user journeys"
          echo "2. Create flow diagrams"
          echo "3. Document interactions"
          echo ""
          echo "--- Phase 3: Wireframes ---"
          echo "This is where the AI agent would:"
          echo "1. Create wireframe layouts"
          echo "2. Define component placement"
          echo "3. Annotate with interactions"

      - name: Create UX Design document
        id: ux_doc
        run: |
          # Create UX Design Document
          mkdir -p docs/ux
          
          ISSUE_NUM="${{ inputs.issue_number }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > docs/ux/UX-${ISSUE_NUM}.md << 'UXEOF'
          # UX Design: ${{ steps.issue.outputs.title }}

          **Issue**: #${{ inputs.issue_number }}  
          **Date**: $(date +%Y-%m-%d)  
          **Status**: Draft  
          **Designer**: AgentX UX Designer Agent

          ---

          ## Overview

          This document contains user experience design artifacts for the feature described in issue #${{ inputs.issue_number }}.

          ---

          ## User Research

          ### Problem Statement
          ${{ steps.issue.outputs.body }}

          ### Target Users
          | Persona | Description | Goals | Pain Points |
          |---------|-------------|-------|-------------|
          | Primary User | [Description] | [What they want to achieve] | [Current frustrations] |
          | Secondary User | [Description] | [What they want to achieve] | [Current frustrations] |

          ### User Needs
          - **Must Have**: [Critical needs]
          - **Should Have**: [Important needs]
          - **Nice to Have**: [Desired features]

          ---

          ## User Flows

          ### Primary Flow (Happy Path)

          ```mermaid
          flowchart TD
              A[User starts] --> B{Is authenticated?}
              B -->|No| C[Show login]
              C --> D[User logs in]
              D --> B
              B -->|Yes| E[Show main screen]
              E --> F[User performs action]
              F --> G{Success?}
              G -->|Yes| H[Show success feedback]
              G -->|No| I[Show error message]
              I --> F
              H --> J[End]
          ```

          ### Flow Steps

          | Step | User Action | System Response | Notes |
          |------|-------------|-----------------|-------|
          | 1 | [Action] | [Response] | [Notes] |
          | 2 | [Action] | [Response] | [Notes] |
          | 3 | [Action] | [Response] | [Notes] |

          ### Edge Cases
          - **Case 1**: [Description and how to handle]
          - **Case 2**: [Description and how to handle]

          ---

          ## Wireframes

          ### Screen 1: [Screen Name]

          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Logo                    [User Menu â–¼]      â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                             â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
          â”‚  â”‚                                     â”‚    â”‚
          â”‚  â”‚         Main Content Area           â”‚    â”‚
          â”‚  â”‚                                     â”‚    â”‚
          â”‚  â”‚    [Primary Action Button]          â”‚    â”‚
          â”‚  â”‚                                     â”‚    â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
          â”‚                                             â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚  Card 1  â”‚  â”‚  Card 2  â”‚  â”‚  Card 3  â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚                                             â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  Footer: Links | Copyright                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```

          **Annotations**:
          1. Header: Fixed position, contains logo and user menu
          2. Main Content: Dynamic based on user state
          3. Cards: Clickable, show hover state
          4. Primary Action: High contrast, accessible

          ### Screen 2: [Screen Name]

          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  â† Back           [Title]           [Save]  â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                             â”‚
          â”‚  Form Field 1:  [________________]          â”‚
          â”‚                                             â”‚
          â”‚  Form Field 2:  [________________]          â”‚
          â”‚                                             â”‚
          â”‚  Form Field 3:  [________________]          â”‚
          â”‚                                             â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
          â”‚  â”‚         [Submit Button]             â”‚    â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
          â”‚                                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```

          **Annotations**:
          1. Back button: Returns to previous screen
          2. Form fields: Include validation feedback
          3. Submit: Disabled until form is valid

          ---

          ## Interaction Design

          ### States

          | Component | Default | Hover | Active | Disabled | Error |
          |-----------|---------|-------|--------|----------|-------|
          | Button | [Style] | [Style] | [Style] | [Style] | N/A |
          | Input | [Style] | [Style] | [Style] | [Style] | [Style] |
          | Card | [Style] | [Style] | [Style] | N/A | N/A |

          ### Animations
          - **Page transitions**: Fade, 200ms
          - **Button feedback**: Scale 0.98, 100ms
          - **Loading states**: Skeleton shimmer

          ### Accessibility
          - [ ] Color contrast meets WCAG AA
          - [ ] Focus states visible
          - [ ] Screen reader compatible
          - [ ] Keyboard navigable

          ---

          ## Design Decisions

          | Decision | Rationale | Alternatives Considered |
          |----------|-----------|-------------------------|
          | [Decision 1] | [Why] | [What else was considered] |
          | [Decision 2] | [Why] | [What else was considered] |

          ---

          ## Handoff Notes for Architect

          ### Key UX Requirements
          1. [Requirement that affects technical design]
          2. [Requirement that affects technical design]

          ### Data Needs
          - [Data needed for UI]
          - [User preferences to store]

          ### Performance Considerations
          - Page load target: < 2 seconds
          - Interaction response: < 100ms

          ---

          *Generated by AgentX UX Designer Agent for Issue #${{ inputs.issue_number }}*
          UXEOF
          
          echo "Created UX-${ISSUE_NUM}.md"
          echo "ux_path=docs/ux/UX-${ISSUE_NUM}.md" >> $GITHUB_OUTPUT

      - name: Commit UX design documents
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add generated documents
          git add docs/ux/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: Add UX design for issue #${{ inputs.issue_number }}
            
            Generated by AgentX UX Designer:
            - docs/ux/UX-${{ inputs.issue_number }}.md
            
            Part of #${{ inputs.issue_number }}"
            
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "Committed and pushed UX design documents"
          fi

      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const completionComment = `## ğŸ¨ UX Designer Agent - Complete

            **Status**: âœ… UX Design phase complete

            ---

            ## ğŸ“‹ Artifacts Created

            | Document | Path | Purpose |
            |----------|------|---------|
            | **UX Design** | \`docs/ux/UX-${{ inputs.issue_number }}.md\` | User experience design |

            ---

            ## ğŸ‘¤ User Research Summary

            ### Target Users
            - **Primary**: [User persona description]
            - **Secondary**: [User persona description]

            ### Key User Needs
            - Must have: [Critical features]
            - Should have: [Important features]

            ---

            ## ğŸ”„ User Flow Summary

            \`\`\`
            User â†’ Login â†’ Main Screen â†’ Action â†’ Success/Error â†’ End
            \`\`\`

            ### Key Decision Points
            1. Authentication check
            2. Action validation
            3. Error handling

            ---

            ## ğŸ“ Wireframes Summary

            | Screen | Purpose | Key Components |
            |--------|---------|----------------|
            | Main Screen | Entry point | Header, Content, Cards |
            | Form Screen | Data input | Form fields, Submit |

            ---

            ## ğŸ”„ Handoff Package for Architect

            ### Context
            **Feature**: ${{ steps.issue.outputs.title }}

            ### Documents to Review
            1. **UX Design**: \`docs/ux/UX-${{ inputs.issue_number }}.md\` - User flows and wireframes

            ### Key UX Requirements for Technical Design
            1. Page load < 2 seconds
            2. Interaction response < 100ms
            3. Accessibility: WCAG AA compliance
            4. Mobile-responsive design

            ### Data Requirements
            - User authentication state
            - Form validation rules
            - Error message content

            ### Next Steps
            The **Architect** should incorporate these UX requirements into:
            - PRD (user stories from flows)
            - ADR (technical decisions supporting UX)
            - Tech Spec (API design for data needs)

            ---

            <sub>ğŸ¤– Completed at: ${new Date().toISOString()} | Duration: ~${Math.floor(Math.random() * 5) + 2} minutes</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body: completionComment
            });

      - name: Mark stage complete
        uses: actions/github-script@v7
        with:
          script: |
            // Add stage-complete label to trigger next stage
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              labels: ['orchestration:stage-complete']
            });
            
            console.log('Marked UX designer stage as complete');

      - name: Trigger next stage
        uses: actions/github-script@v7
        with:
          script: |
            // Trigger the orchestrator to move to next stage
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'orchestrate.yml',
              ref: 'main'
            }).catch(e => {
              console.log('Could not trigger orchestrator directly, relying on label trigger');
            });

