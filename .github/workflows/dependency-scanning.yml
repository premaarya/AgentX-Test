name: Dependency Scanning

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday at midnight
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dotnet-scan:
    name: Scan .NET Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for .NET projects
        id: detect
        run: |
          if find . -name '*.csproj' -o -name '*.sln' | grep -q .; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No .NET projects found - skipping scan"
          fi

      - name: Setup .NET
        if: steps.detect.outputs.found == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        if: steps.detect.outputs.found == 'true'
        run: dotnet restore

      - name: Check for vulnerable packages
        if: steps.detect.outputs.found == 'true'
        id: check
        run: |
          echo "Scanning for vulnerable .NET packages..."
          dotnet list package --vulnerable --include-transitive > vulnerabilities.txt 2>&1 || true

          if grep -q "has the following vulnerable packages" vulnerabilities.txt; then
            echo "HAS_VULNERABILITIES=true" >> $GITHUB_OUTPUT
            echo "::warning::Vulnerable .NET packages found"
            cat vulnerabilities.txt
          else
            echo "HAS_VULNERABILITIES=false" >> $GITHUB_OUTPUT
            echo "[PASS] No vulnerable packages found"
          fi

      - name: Upload vulnerability report
        if: steps.check.outputs.HAS_VULNERABILITIES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-vulnerabilities
          path: vulnerabilities.txt

  python-scan:
    name: Scan Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Python projects
        id: detect
        run: |
          if find . -name 'requirements.txt' -o -name 'Pipfile' -o -name 'pyproject.toml' | grep -q .; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No Python dependency files found - skipping scan"
          fi

      - name: Setup Python
        if: steps.detect.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        if: steps.detect.outputs.found == 'true'
        run: pip install pip-audit

      - name: Scan Python dependencies
        if: steps.detect.outputs.found == 'true'
        id: scan
        run: |
          echo "Scanning for vulnerable Python packages..."
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt --format json > python-vulnerabilities.json || true
          elif [ -f Pipfile ]; then
            pip-audit --requirement <(pipenv requirements) --format json > python-vulnerabilities.json || true
          fi

          if [ -s python-vulnerabilities.json ]; then
            echo "HAS_VULNERABILITIES=true" >> $GITHUB_OUTPUT
            echo "::warning::Vulnerable Python packages found"
            cat python-vulnerabilities.json
          else
            echo "HAS_VULNERABILITIES=false" >> $GITHUB_OUTPUT
            echo "[PASS] No vulnerable packages found"
          fi

      - name: Upload vulnerability report
        if: steps.scan.outputs.HAS_VULNERABILITIES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: python-vulnerabilities
          path: python-vulnerabilities.json

  node-scan:
    name: Scan Node.js Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Node.js projects
        id: detect
        run: |
          PKG_DIR=$(find . -name 'package.json' -not -path '*/node_modules/*' -printf '%h\n' | head -1)
          if [ -n "$PKG_DIR" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "pkg_dir=$PKG_DIR" >> $GITHUB_OUTPUT
            echo "Found Node.js project in $PKG_DIR"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No Node.js projects found - skipping scan"
          fi

      - name: Setup Node.js
        if: steps.detect.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.detect.outputs.found == 'true'
        working-directory: ${{ steps.detect.outputs.pkg_dir }}
        run: npm ci

      - name: Run npm audit
        if: steps.detect.outputs.found == 'true'
        id: audit
        working-directory: ${{ steps.detect.outputs.pkg_dir }}
        run: |
          echo "Scanning for vulnerable Node.js packages..."
          npm audit --json > npm-vulnerabilities.json || true

          HIGH_VULNS=$(jq '.metadata.vulnerabilities.high // 0' npm-vulnerabilities.json 2>/dev/null || echo 0)
          CRITICAL_VULNS=$(jq '.metadata.vulnerabilities.critical // 0' npm-vulnerabilities.json 2>/dev/null || echo 0)

          echo "High: $HIGH_VULNS, Critical: $CRITICAL_VULNS"

          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "HAS_VULNERABILITIES=true" >> $GITHUB_OUTPUT
            echo "::warning::Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities in Node.js dependencies"
          else
            echo "HAS_VULNERABILITIES=false" >> $GITHUB_OUTPUT
            echo "[PASS] No high/critical vulnerabilities found"
          fi

      - name: Upload vulnerability report
        if: steps.audit.outputs.HAS_VULNERABILITIES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: npm-vulnerabilities
          path: ${{ steps.detect.outputs.pkg_dir }}/npm-vulnerabilities.json

  summary:
    name: Dependency Scan Summary
    runs-on: ubuntu-latest
    needs: [dotnet-scan, python-scan, node-scan]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Dependency Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DOTNET_STATUS="${{ needs.dotnet-scan.result }}"
          PYTHON_STATUS="${{ needs.python-scan.result }}"
          NODE_STATUS="${{ needs.node-scan.result }}"

          echo "| Ecosystem | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$DOTNET_STATUS" == "success" ]; then
            echo "| .NET | [PASS] No vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOTNET_STATUS" == "failure" ]; then
            echo "| .NET | [FAIL] Vulnerabilities found |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOTNET_STATUS" == "skipped" ]; then
            echo "| .NET | [SKIP] Skipped (no .NET files) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PYTHON_STATUS" == "success" ]; then
            echo "| Python | [PASS] No vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          elif [ "$PYTHON_STATUS" == "failure" ]; then
            echo "| Python | [FAIL] Vulnerabilities found |" >> $GITHUB_STEP_SUMMARY
          elif [ "$PYTHON_STATUS" == "skipped" ]; then
            echo "| Python | [SKIP] Skipped (no Python files) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$NODE_STATUS" == "success" ]; then
            echo "| Node.js | [PASS] No vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          elif [ "$NODE_STATUS" == "failure" ]; then
            echo "| Node.js | [FAIL] Vulnerabilities found |" >> $GITHUB_STEP_SUMMARY
          elif [ "$NODE_STATUS" == "skipped" ]; then
            echo "| Node.js | [SKIP] Skipped (no Node.js files) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Scanned on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const dotnetStatus = '${{ needs.dotnet-scan.result }}';
            const pythonStatus = '${{ needs.python-scan.result }}';
            const nodeStatus = '${{ needs.node-scan.result }}';

            let status = '[PASS] All dependency scans passed';
            let hasFailures = false;

            if (dotnetStatus === 'failure' || pythonStatus === 'failure' || nodeStatus === 'failure') {
              status = '[FAIL] Vulnerabilities detected';
              hasFailures = true;
            }

            const body = `## Dependency Scan Results

            ${status}

            | Ecosystem | Status |
            |-----------|--------|
            | .NET | ${dotnetStatus === 'success' ? '[PASS]' : dotnetStatus === 'failure' ? '[FAIL]' : '[SKIP]'} ${dotnetStatus === 'skipped' ? 'Skipped' : dotnetStatus === 'success' ? 'No vulnerabilities' : 'Vulnerabilities found'} |
            | Python | ${pythonStatus === 'success' ? '[PASS]' : pythonStatus === 'failure' ? '[FAIL]' : '[SKIP]'} ${pythonStatus === 'skipped' ? 'Skipped' : pythonStatus === 'success' ? 'No vulnerabilities' : 'Vulnerabilities found'} |
            | Node.js | ${nodeStatus === 'success' ? '[PASS]' : nodeStatus === 'failure' ? '[FAIL]' : '[SKIP]'} ${nodeStatus === 'skipped' ? 'Skipped' : nodeStatus === 'success' ? 'No vulnerabilities' : 'Vulnerabilities found'} |

            ${hasFailures ? '[WARN] **Action Required**: Review vulnerability reports in workflow artifacts.' : ''}

            ---
            *Dependency scanning by AgentX*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
