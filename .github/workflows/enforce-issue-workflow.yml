# Enforce Issue-First Workflow
# This action ensures all commits reference a GitHub Issue that was created BEFORE the commit.
# Part of the AgentX mandatory workflow enforcement.

name: Enforce Issue-First Workflow

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  check-issue-reference:
    name: Verify Issue References
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit analysis
      
      - name: Check commits for issue references
        uses: actions/github-script@v7
        with:
          script: |
            const issuePattern = /#(\d+)|(?:closes|fixes|resolves|refs?)\s+#(\d+)/gi;
            
            // Skip certain commit types that don't need issues
            const skipPatterns = [
              /^merge\s/i,
              /^revert\s/i,
              /^\[skip-issue\]/i,
              /^initial commit/i
            ];
            
            let commits = [];
            
            // Handle push events
            if (context.eventName === 'push') {
              commits = context.payload.commits || [];
            }
            
            // Handle pull request events
            if (context.eventName === 'pull_request') {
              const prCommits = await github.rest.pulls.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              });
              commits = prCommits.data.map(c => ({
                message: c.commit.message,
                timestamp: c.commit.author?.date || c.commit.committer?.date,
                id: c.sha
              }));
            }
            
            if (commits.length === 0) {
              console.log('‚ÑπÔ∏è No commits to check');
              return;
            }
            
            console.log(`üìã Checking ${commits.length} commit(s) for issue references...\n`);
            
            const errors = [];
            const warnings = [];
            
            for (const commit of commits) {
              const message = commit.message;
              const shortMsg = message.split('\n')[0];
              const commitId = (commit.id || commit.sha || 'unknown').substring(0, 7);
              
              // Check if commit should be skipped
              const shouldSkip = skipPatterns.some(pattern => pattern.test(message));
              if (shouldSkip) {
                console.log(`‚è≠Ô∏è Skipping: ${commitId} - "${shortMsg}" (exempt pattern)`);
                continue;
              }
              
              // Check for issue reference
              const matches = message.match(issuePattern);
              
              if (!matches) {
                errors.push({
                  commit: commitId,
                  message: shortMsg,
                  error: 'No issue reference found'
                });
                continue;
              }
              
              // Verify each referenced issue
              for (const match of matches) {
                const issueNum = parseInt(match.replace(/\D/g, ''));
                
                try {
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNum
                  });
                  
                  // Check if issue was created before commit
                  const issueCreated = new Date(issue.data.created_at);
                  const commitDate = new Date(commit.timestamp);
                  
                  if (issueCreated > commitDate) {
                    errors.push({
                      commit: commitId,
                      message: shortMsg,
                      error: `Issue #${issueNum} was created AFTER this commit (retroactive issue - workflow violation)`
                    });
                  } else {
                    console.log(`‚úÖ ${commitId}: Issue #${issueNum} verified (created ${issueCreated.toISOString()} < commit ${commitDate.toISOString()})`);
                  }
                  
                  // Check if issue had in-progress label (warning only)
                  const labels = issue.data.labels.map(l => l.name);
                  const hadInProgress = labels.includes('status:in-progress') || 
                                        labels.includes('status:done');
                  
                  if (!hadInProgress) {
                    warnings.push({
                      commit: commitId,
                      issue: issueNum,
                      warning: 'Issue may not have been claimed (no status:in-progress label found)'
                    });
                  }
                  
                } catch (e) {
                  if (e.status === 404) {
                    errors.push({
                      commit: commitId,
                      message: shortMsg,
                      error: `Issue #${issueNum} not found in repository`
                    });
                  } else {
                    console.log(`‚ö†Ô∏è Could not verify issue #${issueNum}: ${e.message}`);
                  }
                }
              }
            }
            
            // Report warnings
            if (warnings.length > 0) {
              console.log('\n‚ö†Ô∏è Warnings:');
              for (const w of warnings) {
                console.log(`   ${w.commit}: Issue #${w.issue} - ${w.warning}`);
              }
            }
            
            // Report errors and fail if any
            if (errors.length > 0) {
              console.log('\n');
              let errorMsg = '‚ùå Issue-First Workflow Violations Found:\n\n';
              
              for (const err of errors) {
                errorMsg += `‚Ä¢ Commit ${err.commit}: "${err.message}"\n  Error: ${err.error}\n\n`;
              }
              
              errorMsg += 'üìñ How to fix:\n';
              errorMsg += '1. Create a GitHub Issue BEFORE making changes\n';
              errorMsg += '2. Claim the issue with status:in-progress label\n';
              errorMsg += '3. Reference the issue in your commit message (#123)\n';
              errorMsg += '4. See AGENTS.md for complete workflow details\n';
              
              core.setFailed(errorMsg);
            } else {
              console.log('\n‚úÖ All commits have valid issue references');
            }
