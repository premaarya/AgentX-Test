#!/usr/bin/env bash
# Pre-commit hook: Enforces Issue-First workflow
# Validates commit messages reference GitHub Issues

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip for merge commits, reverts, and initial commits
if echo "$COMMIT_MSG" | grep -qE '^(Merge|Revert|Initial commit)'; then
  exit 0
fi

# Skip if [skip-issue] in commit message (emergency only)
if echo "$COMMIT_MSG" | grep -qE '\[skip-issue\]'; then
  echo "‚ö†Ô∏è  WARNING: Skipping issue validation (emergency mode)"
  exit 0
fi

# Check for issue reference: #123 or closes #123, fixes #123, refs #123
if ! echo "$COMMIT_MSG" | grep -qE '#[0-9]+|((closes|fixes|resolves|refs?)\s+#[0-9]+)'; then
  echo "‚ùå COMMIT REJECTED: No GitHub Issue reference found"
  echo ""
  echo "Your commit message must reference a GitHub Issue."
  echo ""
  echo "Valid formats:"
  echo "  - feat: add login button (#123)"
  echo "  - fix: resolve crash on startup (fixes #456)"
  echo "  - docs: update README (refs #789)"
  echo ""
  echo "To create an issue:"
  echo "  gh issue create --web"
  echo ""
  echo "Emergency bypass (NOT RECOMMENDED):"
  echo "  Add [skip-issue] to your commit message"
  echo ""
  exit 1
fi

# Extract issue number
ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oP '#\K\d+' | head -1)

# Validate workflow documents exist (if GitHub CLI is available)
if command -v gh &> /dev/null && [ -n "$ISSUE_NUMBER" ]; then
  # Get issue labels
  ISSUE_LABELS=$(gh issue view $ISSUE_NUMBER --json labels -q '.labels[].name' 2>/dev/null || echo "")
  
  if [ -n "$ISSUE_LABELS" ]; then
    # Extract type label
    ISSUE_TYPE=$(echo "$ISSUE_LABELS" | grep "type:" | head -1)
    
    # Validate workflow documents based on issue type
    case $ISSUE_TYPE in
      "type:epic")
        if [ ! -f "docs/prd/PRD-${ISSUE_NUMBER}.md" ]; then
          echo "‚ùå COMMIT REJECTED: Epic requires PRD before code"
          echo ""
          echo "  Issue: #${ISSUE_NUMBER} (type:epic)"
          echo "  Missing: docs/prd/PRD-${ISSUE_NUMBER}.md"
          echo ""
          echo "üìã Epic workflow: Product Manager ‚Üí PRD ‚Üí then code"
          echo ""
          echo "  Fix: Create PRD before committing code"
          echo "       See .github/templates/PRD-TEMPLATE.md"
          echo ""
          exit 1
        fi
        ;;
      "type:feature")
        # Feature requires both ADR and Tech Spec
        if [ ! -f "docs/adr/ADR-${ISSUE_NUMBER}.md" ]; then
          echo "‚ùå COMMIT REJECTED: Feature requires ADR before code"
          echo ""
          echo "  Issue: #${ISSUE_NUMBER} (type:feature)"
          echo "  Missing: docs/adr/ADR-${ISSUE_NUMBER}.md"
          echo ""
          echo "üìê Feature workflow: Architect ‚Üí ADR ‚Üí Spec ‚Üí then code"
          echo ""
          echo "  Fix: Create Architecture Decision Record before committing code"
          echo "       See .github/templates/ADR-TEMPLATE.md"
          echo ""
          exit 1
        fi
        if [ ! -f "docs/specs/SPEC-${ISSUE_NUMBER}.md" ]; then
          echo "‚ùå COMMIT REJECTED: Feature requires Tech Spec before code"
          echo ""
          echo "  Issue: #${ISSUE_NUMBER} (type:feature)"
          echo "  Missing: docs/specs/SPEC-${ISSUE_NUMBER}.md"
          echo ""
          echo "üìê Feature workflow: Architect ‚Üí ADR ‚Üí Spec ‚Üí then code"
          echo ""
          echo "  Fix: Create Tech Spec before committing code"
          echo "       See .github/templates/SPEC-TEMPLATE.md"
          echo ""
          exit 1
        fi
        ;;
    esac
    
    # Check if UX design is required (needs:ux label)
    if echo "$ISSUE_LABELS" | grep -q "needs:ux"; then
      if [ ! -f "docs/ux/UX-${ISSUE_NUMBER}.md" ]; then
        echo "‚ùå COMMIT REJECTED: Issue requires UX design before code"
        echo ""
        echo "  Issue: #${ISSUE_NUMBER} (needs:ux)"
        echo "  Missing: docs/ux/UX-${ISSUE_NUMBER}.md"
        echo ""
        echo "üé® UX workflow: UX Designer ‚Üí UX Design ‚Üí then code"
        echo ""
        echo "  Fix: Create UX design document before committing code"
        echo "       See .github/templates/UX-TEMPLATE.md"
        echo ""
        exit 1
      fi
    fi
  fi
fi

# Check commit message format (type: description)
if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|test|refactor|perf|chore|style):'; then
  echo "‚ö†Ô∏è  WARNING: Commit message should follow format: 'type: description (#issue)'"
  echo ""
  echo "Valid types: feat, fix, docs, test, refactor, perf, chore, style"
  echo ""
  # Warning only, don't fail
fi

echo "‚úÖ Commit message validated"
exit 0
