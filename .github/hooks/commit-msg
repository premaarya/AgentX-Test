#!/usr/bin/env bash
# Commit-msg hook: Issue-First Workflow Validation
# Single source of truth for all workflow enforcement

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BLUE}AgentX Workflow Validation${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Skip for merge commits, reverts, and initial commits
if echo "$COMMIT_MSG" | grep -qE '^(Merge|Revert|Initial commit)'; then
  echo -e "${GREEN}‚úÖ Merge/Revert commit - skipping validation${NC}"
  exit 0
fi

# Skip if [skip-issue] in commit message (emergency only)
if echo "$COMMIT_MSG" | grep -qE '\[skip-issue\]'; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Skipping issue validation (emergency mode)${NC}"
  exit 0
fi

# ===================================================================
# STEP 1: Check for issue reference
# ===================================================================
echo -n "Checking for issue reference... "
if ! echo "$COMMIT_MSG" | grep -qE '#[0-9]+|((closes|fixes|resolves|refs?)\s+#[0-9]+)'; then
  echo -e "${RED}‚ùå FAILED${NC}"
  echo ""
  echo "Your commit message must reference a GitHub Issue."
  echo ""
  echo -e "  ${GREEN}Format:${NC} type: description (#123)"
  echo -e "  ${GREEN}Example:${NC} feat: add user login (#42)"
  echo ""
  echo "To create an issue: gh issue create --web"
  echo ""
  echo "Emergency bypass: Add [skip-issue] to commit message"
  echo ""
  exit 1
fi

ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oP '#\K\d+' | head -1)
echo -e "${GREEN}‚úÖ Found #${ISSUE_NUMBER}${NC}"

# ===================================================================
# STEP 2: Validate workflow documents (if gh CLI available)
# ===================================================================
if ! command -v gh &> /dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  Skipping workflow validation (gh CLI not found)${NC}"
  exit 0
fi

# Get issue labels
ISSUE_LABELS=$(gh issue view $ISSUE_NUMBER --json labels -q '.labels[].name' 2>/dev/null || echo "")

if [ -z "$ISSUE_LABELS" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Could not fetch issue #${ISSUE_NUMBER}${NC}"
  exit 0
fi

# Extract type label
ISSUE_TYPE=$(echo "$ISSUE_LABELS" | grep "type:" | head -1)

if [ -z "$ISSUE_TYPE" ]; then
  echo -e "${RED}‚ùå Issue #${ISSUE_NUMBER} has no type label${NC}"
  echo ""
  echo "Add a type label: type:epic, type:feature, type:story, type:bug, type:spike, type:docs"
  echo ""
  exit 1
fi

echo -e "Issue type: ${GREEN}${ISSUE_TYPE}${NC}"

# ===================================================================
# STEP 3: Validate required documents per workflow
# ===================================================================
echo -n "Checking workflow documents... "

case $ISSUE_TYPE in
  "type:epic")
    if [ ! -f "docs/prd/PRD-${ISSUE_NUMBER}.md" ]; then
      echo -e "${RED}‚ùå FAILED${NC}"
      echo ""
      echo "  Epic requires PRD before code!"
      echo "  Missing: docs/prd/PRD-${ISSUE_NUMBER}.md"
      echo ""
      echo "  üìã Workflow: PM creates PRD ‚Üí then code"
      echo "  Template: .github/templates/PRD-TEMPLATE.md"
      echo ""
      exit 1
    fi
    echo -e "${GREEN}‚úÖ PRD exists${NC}"
    ;;
    
  "type:feature")
    MISSING=""
    if [ ! -f "docs/adr/ADR-${ISSUE_NUMBER}.md" ]; then
      MISSING="ADR"
    fi
    if [ ! -f "docs/specs/SPEC-${ISSUE_NUMBER}.md" ]; then
      MISSING="${MISSING:+$MISSING + }Spec"
    fi
    if [ -n "$MISSING" ]; then
      echo -e "${RED}‚ùå FAILED${NC}"
      echo ""
      echo "  Feature requires ${MISSING} before code!"
      echo ""
      echo "  üìê Workflow: Architect creates ADR + Spec ‚Üí then code"
      echo "  Templates: .github/templates/ADR-TEMPLATE.md, SPEC-TEMPLATE.md"
      echo ""
      exit 1
    fi
    echo -e "${GREEN}‚úÖ ADR + Spec exist${NC}"
    ;;
    
  "type:story"|"type:bug"|"type:spike"|"type:docs")
    echo -e "${GREEN}‚úÖ No prereqs for ${ISSUE_TYPE}${NC}"
    ;;
    
  *)
    echo -e "${GREEN}‚úÖ Unknown type - skipping${NC}"
    ;;
esac

# ===================================================================
# STEP 4: Check UX requirement (needs:ux label)
# ===================================================================
if echo "$ISSUE_LABELS" | grep -q "needs:ux"; then
  echo -n "Checking UX design... "
  if [ ! -f "docs/ux/UX-${ISSUE_NUMBER}.md" ]; then
    echo -e "${RED}‚ùå FAILED${NC}"
    echo ""
    echo "  Issue has needs:ux label - UX design required!"
    echo "  Missing: docs/ux/UX-${ISSUE_NUMBER}.md"
    echo ""
    echo "  üé® Workflow: UX Designer creates design ‚Üí then code"
    echo "  Template: .github/templates/UX-TEMPLATE.md"
    echo ""
    exit 1
  fi
  echo -e "${GREEN}‚úÖ UX design exists${NC}"
fi

# ===================================================================
# STEP 5: Validate commit message format (warning only)
# ===================================================================
if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|test|refactor|perf|chore|style|build|ci):'; then
  echo -e "${YELLOW}‚ö†Ô∏è  Commit format should be: type: description (#issue)${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ Workflow validation passed${NC}"
exit 0
