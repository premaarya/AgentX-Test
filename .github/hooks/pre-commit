#!/usr/bin/env bash
# Pre-commit hook: Security and quality checks
# Runs before commit to catch issues early

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

FAILED=0

# ===================================================================
# AGENTX WORKFLOW VALIDATION
# ===================================================================

echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BLUE}AgentX Workflow Validation${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Extract issue number from commit message
COMMIT_MSG=""
ISSUE_NUMBER=""

# Check if COMMIT_EDITMSG exists (when using git commit without -m or during interactive commit)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oP '#\K\d+' | head -1)
  
  echo -n "Checking for issue reference... "
  if [ -z "$ISSUE_NUMBER" ]; then
    echo -e "${RED}‚ùå BLOCKED${NC}"
    echo ""
    echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo -e "‚ïë  ${RED}WORKFLOW VIOLATION: No issue number in commit${NC}    ‚ïë"
    echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "Your commit message must reference a GitHub issue:"
    echo ""
    echo "  ${GREEN}Required format:${NC} type: description (#123)"
    echo ""
    echo "  ${GREEN}Example:${NC} feat: add user authentication (#42)"
    echo ""
    echo "üìñ See AGENTS.md for workflow details"
    echo ""
    FAILED=1
  else
    echo -e "${GREEN}‚úÖ Found #${ISSUE_NUMBER}${NC}"
    
    # Check if GitHub CLI is available
    if command -v gh &> /dev/null; then
      echo -n "Validating issue type and required documents... "
      
      # Get issue labels
      ISSUE_LABELS=$(gh issue view $ISSUE_NUMBER --json labels -q '.labels[].name' 2>/dev/null || echo "")
      
      if [ -z "$ISSUE_LABELS" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
        echo "  Could not fetch issue #${ISSUE_NUMBER} labels"
        echo "  Ensure the issue exists and you're authenticated (gh auth login)"
      else
        # Extract type label
        ISSUE_TYPE=$(echo "$ISSUE_LABELS" | grep "type:" | head -1)
        
        if [ -z "$ISSUE_TYPE" ]; then
          echo -e "${RED}‚ùå BLOCKED${NC}"
          echo ""
          echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo -e "‚ïë  ${RED}WORKFLOW VIOLATION: Issue #${ISSUE_NUMBER} has no type${NC}      ‚ïë"
          echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "Issue must have a type label:"
          echo "  ‚Ä¢ type:epic, type:feature, type:story, type:bug, type:spike, type:docs"
          echo ""
          echo "  ${GREEN}Fix:${NC} gh issue edit ${ISSUE_NUMBER} --add-label \"type:story\""
          echo ""
          FAILED=1
        else
          # Validate workflow documents based on issue type
          case $ISSUE_TYPE in
            "type:epic")
              if [ ! -f "docs/prd/PRD-${ISSUE_NUMBER}.md" ]; then
                echo -e "${RED}‚ùå BLOCKED${NC}"
                echo ""
                echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo -e "‚ïë  ${RED}WORKFLOW VIOLATION: Epic requires PRD first${NC}       ‚ïë"
                echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                echo "  Issue: #${ISSUE_NUMBER} (type:epic)"
                echo "  Missing: docs/prd/PRD-${ISSUE_NUMBER}.md"
                echo ""
                echo "üìã Epic workflow: Product Manager ‚Üí PRD ‚Üí then code"
                echo ""
                echo "  ${GREEN}Fix:${NC} Create PRD before committing code"
                echo "       See .github/templates/PRD-TEMPLATE.md"
                echo ""
                FAILED=1
              else
                echo -e "${GREEN}‚úÖ PRD exists${NC}"
              fi
              ;;
            "type:feature")
              # Feature requires both ADR and Tech Spec
              if [ ! -f "docs/adr/ADR-${ISSUE_NUMBER}.md" ]; then
                echo -e "${RED}‚ùå BLOCKED${NC}"
                echo ""
                echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo -e "‚ïë  ${RED}WORKFLOW VIOLATION: Feature requires ADR first${NC}    ‚ïë"
                echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                echo "  Issue: #${ISSUE_NUMBER} (type:feature)"
                echo "  Missing: docs/adr/ADR-${ISSUE_NUMBER}.md"
                echo ""
                echo "üìê Feature workflow: Architect ‚Üí ADR ‚Üí Spec ‚Üí then code"
                echo ""
                echo "  ${GREEN}Fix:${NC} Create Architecture Decision Record before committing code"
                echo "       See .github/templates/ADR-TEMPLATE.md"
                echo ""
                FAILED=1
              elif [ ! -f "docs/specs/SPEC-${ISSUE_NUMBER}.md" ]; then
                echo -e "${RED}‚ùå BLOCKED${NC}"
                echo ""
                echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                echo -e "‚ïë  ${RED}WORKFLOW VIOLATION: Feature requires Spec first${NC}   ‚ïë"
                echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                echo ""
                echo "  Issue: #${ISSUE_NUMBER} (type:feature)"
                echo "  Missing: docs/specs/SPEC-${ISSUE_NUMBER}.md"
                echo ""
                echo "üìê Feature workflow: Architect ‚Üí ADR ‚Üí Spec ‚Üí then code"
                echo ""
                echo "  ${GREEN}Fix:${NC} Create Tech Spec before committing code"
                echo "       See .github/templates/SPEC-TEMPLATE.md"
                echo ""
                FAILED=1
              else
                echo -e "${GREEN}‚úÖ ADR and Spec exist${NC}"
              fi
              ;;
            *)
              echo -e "${GREEN}‚úÖ Type: ${ISSUE_TYPE}${NC}"
              ;;
          esac
          
          # Check if UX design is required (needs:ux label)
          if echo "$ISSUE_LABELS" | grep -q "needs:ux"; then
            if [ ! -f "docs/ux/UX-${ISSUE_NUMBER}.md" ]; then
              echo -e "${RED}‚ùå BLOCKED${NC}"
              echo ""
              echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
              echo -e "‚ïë  ${RED}WORKFLOW VIOLATION: UX design required first${NC}      ‚ïë"
              echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
              echo ""
              echo "  Issue: #${ISSUE_NUMBER} (needs:ux)"
              echo "  Missing: docs/ux/UX-${ISSUE_NUMBER}.md"
              echo ""
              echo "üé® UX workflow: UX Designer ‚Üí UX Design ‚Üí then code"
              echo ""
              echo "  ${GREEN}Fix:${NC} Create UX design document before committing code"
              echo "       See .github/templates/UX-TEMPLATE.md"
              echo ""
              FAILED=1
            else
              echo -e "${GREEN}‚úÖ UX design exists${NC}"
            fi
          fi
        fi
      fi
    else
      echo -e "${YELLOW}‚ö†Ô∏è  SKIPPED (GitHub CLI not found)${NC}"
      echo "  Install: https://cli.github.com/"
    fi
  fi
fi

echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BLUE}Security & Quality Checks${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Check 1: No secrets in staged files
echo -n "Checking for secrets... "
if git diff --cached --name-only | xargs grep -E '(password|api[_-]?key|secret|token|private[_-]?key)\s*=\s*["\x27][^"\x27]+["\x27]' -i 2>/dev/null; then
  echo -e "${RED}‚ùå FAILED${NC}"
  echo "  Found potential secrets in staged files!"
  echo "  Use environment variables instead."
  FAILED=1
else
  echo -e "${GREEN}‚úÖ PASSED${NC}"
fi

# Check 2: No large files (>1MB)
echo -n "Checking file sizes... "
LARGE_FILES=$(git diff --cached --name-only | xargs ls -l 2>/dev/null | awk '$5 > 1048576 {print $9}')
if [ -n "$LARGE_FILES" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
  echo "  Large files detected (>1MB):"
  echo "$LARGE_FILES" | sed 's/^/    /'
  echo "  Consider using Git LFS for large files."
  # Warning only, don't fail
else
  echo -e "${GREEN}‚úÖ PASSED${NC}"
fi

# Check 3: No direct master/main commits
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
  echo "  You're committing directly to $BRANCH"
  echo "  Consider using feature branches instead"
  # Warning only, don't fail
fi

# Check 4: Run formatters (if available)
if command -v dotnet &> /dev/null; then
  echo -n "Checking C# formatting... "
  # Only format C# files that are staged
  CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$')
  if [ -n "$CS_FILES" ]; then
    if dotnet format --verify-no-changes --include $CS_FILES &>/dev/null; then
      echo -e "${GREEN}‚úÖ PASSED${NC}"
    else
      echo -e "${YELLOW}‚ö†Ô∏è  NEEDS FORMATTING${NC}"
      echo "  Run: dotnet format"
      # Auto-format and re-stage
      dotnet format --include $CS_FILES
      echo "$CS_FILES" | xargs git add
      echo "  Files auto-formatted and re-staged"
    fi
  else
    echo -e "${GREEN}‚úÖ SKIPPED (no C# files)${NC}"
  fi
fi

if command -v black &> /dev/null; then
  echo -n "Checking Python formatting... "
  PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')
  if [ -n "$PY_FILES" ]; then
    if black --check $PY_FILES &>/dev/null; then
      echo -e "${GREEN}‚úÖ PASSED${NC}"
    else
      echo -e "${YELLOW}‚ö†Ô∏è  NEEDS FORMATTING${NC}"
      echo "  Run: black $PY_FILES"
      # Auto-format and re-stage
      black $PY_FILES
      echo "$PY_FILES" | xargs git add
      echo "  Files auto-formatted and re-staged"
    fi
  else
    echo -e "${GREEN}‚úÖ SKIPPED (no Python files)${NC}"
  fi
fi

# Check 5: SQL injection patterns
echo -n "Checking for SQL injection risks... "
if git diff --cached | grep -E '\+.*\b(ExecuteRaw|FromSqlRaw|SqlQuery).*\+' | grep -v 'parameterized' | grep -v '@' &>/dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
  echo "  Found potential SQL injection risks"
  echo "  Ensure all queries are parameterized"
  # Warning only, don't fail
else
  echo -e "${GREEN}‚úÖ PASSED${NC}"
fi

# Summary
echo ""
if [ $FAILED -eq 1 ]; then
  echo -e "${RED}‚ùå Pre-commit checks FAILED${NC}"
  echo "Fix the issues above and try again."
  exit 1
else
  echo -e "${GREEN}‚úÖ All checks passed${NC}"
  exit 0
fi
