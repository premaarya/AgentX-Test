#!/usr/bin/env bash
# Pre-commit hook: Security and quality checks
# Runs before commit to catch issues early

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Check 1: No secrets in staged files
echo -n "Checking for secrets... "
if git diff --cached --name-only | xargs grep -E '(password|api[_-]?key|secret|token|private[_-]?key)\s*=\s*["\x27][^"\x27]+["\x27]' -i 2>/dev/null; then
  echo -e "${RED}‚ùå FAILED${NC}"
  echo "  Found potential secrets in staged files!"
  echo "  Use environment variables instead."
  FAILED=1
else
  echo -e "${GREEN}‚úÖ PASSED${NC}"
fi

# Check 2: No large files (>1MB)
echo -n "Checking file sizes... "
LARGE_FILES=$(git diff --cached --name-only | xargs ls -l 2>/dev/null | awk '$5 > 1048576 {print $9}')
if [ -n "$LARGE_FILES" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
  echo "  Large files detected (>1MB):"
  echo "$LARGE_FILES" | sed 's/^/    /'
  echo "  Consider using Git LFS for large files."
  # Warning only, don't fail
else
  echo -e "${GREEN}‚úÖ PASSED${NC}"
fi

# Check 3: No direct master/main commits
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
  echo "  You're committing directly to $BRANCH"
  echo "  Consider using feature branches instead"
  # Warning only, don't fail
fi

# Check 4: Run formatters (if available)
if command -v dotnet &> /dev/null; then
  echo -n "Checking C# formatting... "
  # Only format C# files that are staged
  CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$')
  if [ -n "$CS_FILES" ]; then
    if dotnet format --verify-no-changes --include $CS_FILES &>/dev/null; then
      echo -e "${GREEN}‚úÖ PASSED${NC}"
    else
      echo -e "${YELLOW}‚ö†Ô∏è  NEEDS FORMATTING${NC}"
      echo "  Run: dotnet format"
      # Auto-format and re-stage
      dotnet format --include $CS_FILES
      echo "$CS_FILES" | xargs git add
      echo "  Files auto-formatted and re-staged"
    fi
  else
    echo -e "${GREEN}‚úÖ SKIPPED (no C# files)${NC}"
  fi
fi

if command -v black &> /dev/null; then
  echo -n "Checking Python formatting... "
  PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')
  if [ -n "$PY_FILES" ]; then
    if black --check $PY_FILES &>/dev/null; then
      echo -e "${GREEN}‚úÖ PASSED${NC}"
    else
      echo -e "${YELLOW}‚ö†Ô∏è  NEEDS FORMATTING${NC}"
      echo "  Run: black $PY_FILES"
      # Auto-format and re-stage
      black $PY_FILES
      echo "$PY_FILES" | xargs git add
      echo "  Files auto-formatted and re-staged"
    fi
  else
    echo -e "${GREEN}‚úÖ SKIPPED (no Python files)${NC}"
  fi
fi

# Check 5: SQL injection patterns
echo -n "Checking for SQL injection risks... "
if git diff --cached | grep -E '\+.*\b(ExecuteRaw|FromSqlRaw|SqlQuery).*\+' | grep -v 'parameterized' | grep -v '@' &>/dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING${NC}"
  echo "  Found potential SQL injection risks"
  echo "  Ensure all queries are parameterized"
  # Warning only, don't fail
else
  echo -e "${GREEN}‚úÖ PASSED${NC}"
fi

# Summary
echo ""
if [ $FAILED -eq 1 ]; then
  echo -e "${RED}‚ùå Pre-commit checks FAILED${NC}"
  echo "Fix the issues above and try again."
  exit 1
else
  echo -e "${GREEN}‚úÖ All checks passed${NC}"
  exit 0
fi
